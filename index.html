import React, { useState, useEffect, useRef, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, updateDoc, deleteDoc, query, where } from 'firebase/firestore';
import { Home, DollarSign, TrendingDown, FileText, Users, CreditCard, ShoppingBag } from 'lucide-react'; // Importing new icon for Comercio

// Define Firebase config and app ID from global variables
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Data for dropdowns (simplified for demonstration)
const carData = {
  "Centauro": ["Sedan"],
  "Chery": ["Arauca", "Arrizo", "Orinoco", "QQ", "Tiggo", "X1"],
  "Chevrolet": [
    "Aveo", "Blazer", "Camaro", "Captiva", "Chevy Van", "Colorado", "Corsa", "Corvette", "Cruze",
    "Equinox", "Grand Vitara", "Luv Dmax", "Malibu", "Nova", "Optra", "Silverado", "Sonic", "Spark",
    "Steen", "Suburban", "Tahoe", "Trailblazer", "Traverse", "Tracker", "Vitara"
  ],
  "Chrysler": ["300", "Neon", "Pacifica", "Voyager"],
  "Daewoo": ["Cielo", "Damas", "Lanos", "Leganza", "Matiz", "Nubira"],
  "Dodge": ["Camioneta Ram van", "Challenger", "Charger", "Dakota", "Durango", "Grand Caravan", "Journey", "Ram", "Ram Van"],
  "Fiat": ["Argo", "Cronos", "Mobi", "Palio", "Siena", "Tempra", "Uno"],
  "Ford": ["Ecosport", "Escape", "Explorer", "F-150", "Festiva", "Fiesta", "Focus", "Fusion", "Granada", "Mustang", "Ranger"],
  "Honda": ["Accord", "Civic", "CR-V", "HR-V", "Pilot"],
  "Hyundai": ["Accent", "Elantra", "Kona", "Palisade", "Santa Fe", "Tucson"],
  "Jeep": ["Cherokee", "Gladiator", "Grand Cherokee", "Renegade", "Wrangler"],
  "Kia": ["Forte", "K5", "Picanto", "Rio", "Seltos", "Sorento", "Sportage", "Telluride"],
  "Mazda": ["CX-30", "CX-5", "CX-9", "Mazda3", "Mazda6"],
  "Mitsubishi": ["ASX", "Eclipse Cross", "L200", "Lancer", "Mirage", "Montero", "Outlander"],
  "Nissan": ["Altima", "Frontier", "Pathfinder", "Rogue", "Sentra", "Tiida", "Titan"],
  "Renault": ["Captur", "Clio", "Duster", "Kwid", "Logan", "Sandero", "Symbol"],
  "Suzuki": ["Baleno", "Celerio", "Grand Vitara", "Jimny", "Swift", "Vitara"],
  "Toyota": ["4Runner", "Camry", "Corolla", "Fortuner", "Hilux", "Meru", "Rav4", "Starlet", "Terios", "Yaris"],
  "Volkswagen": ["Atlas", "Golf", "Jetta", "Passat", "Taos", "Tiguan"],
  "Zotye": ["Nomada", "T600", "T700", "Z100"],
  "Otro": [] // Added "Otro" option
};

const colors = [
  "Rojo", "Azul", "Verde", "Negro", "Blanco", "Gris", "Plata", "Marrón", "Amarillo", "Naranja", "Morado", "Rosa", "Dorado", "Bronce", "Beige"
];

const venezuelanBanks = [
  "100% Banco (0156)",
  "Bancamiga (0172)",
  "Bancaribe (0114)",
  "Banco Activo (0171)",
  "Banco Agrícola de Venezuela",
  "Banco Caroní (0128)",
  "Banco de la Fuerza Armada Nacional Bolivariana (BANFANB) (0177)",
  "Banco de Venezuela (0102)",
  "Banco del Tesoro (0163)",
  "Banco Digital de los Trabajadores (0175)",
  "Banco Exterior (0115)",
  "Banco Fondo Común (BFC) (0151)",
  "Banco Mercantil (0105)",
  "Banco Nacional de Crédito (BNC) (0191)",
  "Banco Plaza (0138)",
  "Banco Sofitasa (0137)",
  "Banesco (0134)",
  "Banplus (0174)",
  "BBVA Provincial (0108)",
  "DELSUR Banco Universal (0157)",
  "N58 Banco Digital (0178)",
  "R4 (0169)",
  "Venezolano de Crédito (0104)",
].sort(); // Ensure banks are sorted alphabetically

const paymentConcepts = [
  "Pago de Mensualidad", "Pago de Codificación", "Pago de Cuota especial"
];

const commercialPaymentConcepts = [
  "Aporte Mensual", "Aporte Cuota Especial"
];

const monthsOfYear = [
  "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
  "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
];

// Generate month-year options for checkboxes
const generateMonthYearOptions = () => {
  const currentYear = new Date().getFullYear();
  const yearsToInclude = [currentYear - 1, currentYear, currentYear + 1]; // Previous, current, and next year
  const options = [];
  yearsToInclude.forEach(year => {
    monthsOfYear.forEach(month => {
      options.push({ label: `${month} ${year}`, value: `${month}-${year}` });
    });
  });
  return options;
};

const monthYearOptions = generateMonthYearOptions();

// Options for new dropdowns
const buildingOptions = ["Bloque 22", "Bloque 23", "Bloque 24", "Bloque 25", "Bloque P 29", "Bloque P 30"];
const letterOptions = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"];
const floorOptions = ["PB", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14"];

// Currency purchase mechanisms
const currencyMechanisms = ["Intervencion Cambiaria", "Menudeo", "Mesa de Cambio"];

// New condition options for owners
const conditionOptions = ["Operativo", "Accidentado", "Chatarra"];


// Reusable Button Component
const Button = ({ onClick, children, className = '', disabled = false }) => (
  <button
    onClick={onClick}
    className={`px-4 py-2 rounded-lg shadow-md transition-all duration-200 ease-in-out transform
               ${disabled ? 'bg-gray-400 cursor-not-allowed' : 'hover:scale-105 bg-purple-700 text-white font-semibold hover:bg-purple-800'}
               focus:outline-none focus:ring-2 focus:ring-purple-600 focus:ring-opacity-75 ${className}`}
    disabled={disabled}
  >
    {children}
  </button>
);

// Helper function to safely render values
const safeRender = (value) => {
  if (value === null || value === undefined) return 'N/A';
  if (typeof value === 'object') {
    if (Array.isArray(value)) {
      return value.map(item => safeRender(item)).join(', ');
    }
    // If it's a React element, convert to a descriptive string
    if (value.$$typeof && (typeof value.type === 'string' || typeof value.type === 'function')) {
      return `[React Element: ${value.type.displayName || value.type.name || value.type || 'Unknown'}]`;
    }
    // For any other object that is not an array or React element, return a placeholder
    return '[Objeto]'; // Less aggressive than JSON.stringify
  }
  return String(value);
};

// Helper for number formatting (thousands with dot, decimals with comma)
const formatNumber = (value) => {
  if (typeof value !== 'number' || isNaN(value)) {
    return safeRender(value); // Fallback to safeRender for non-numeric values
  }
  return value.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
};

// Helper for date formatting DD/MM/AAAA
const formatDate = (dateString) => {
  if (!dateString) return 'N/A';
  try {
    const [year, month, day] = dateString.split('-');
    return `${day}/${month}/${year}`;
  } catch (e) {
    console.error("Error formatting date:", dateString, e);
    return dateString; // Return original if formatting fails
  }
};


// Input Field Component
const InputField = ({ label, type = 'text', value, onChange, placeholder, className = '', options = [], disabled = false, children, name, multiple = false }) => {
  const inputClasses = `w-full p-2 border border-gray-300 rounded-md focus:ring-purple-600 focus:border-purple-600 transition duration-150 ease-in-out ${className}`;

  // Ensure value is always a string for input types that expect it
  // For select/checkbox-group, value is used for comparison, not direct rendering in the input itself
  const processedValue = (type === 'text' || type === 'email' || type === 'tel' || type === 'date' || type === 'number')
    ? safeRender(value)
    : value;

  if (type === 'select') {
    return (
      <div className="mb-4">
        <label className="block text-gray-700 text-sm font-bold mb-2">{label}</label>
        <select
          value={String(processedValue || '')} // Explicitly convert to string and handle null/undefined
          onChange={onChange}
          className={inputClasses}
          disabled={disabled}
          name={name}
          multiple={multiple}
        >
          {placeholder && <option value="">{placeholder}</option>}
          {options.length > 0 ? options.map((option, index) => (
            <option key={index} value={String(safeRender(option.value || option || ''))}>{String(safeRender(option.label || option || ''))}</option> // Explicitly convert to string and handle null/undefined
          )) : children}
        </select>
      </div>
    );
  } else if (type === 'checkbox-group') {
    return (
      <div className="mb-4">
        <label className="block text-gray-700 text-sm font-bold mb-2">{label}</label>
        <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-48 overflow-y-auto border p-2 rounded-md bg-white">
          {options.map((option, index) => (
            <label key={index} className="inline-flex items-center text-sm text-gray-700">
              <input
                type="checkbox"
                name={name}
                value={safeRender(option.value || option)}
                checked={Array.isArray(value) && value.includes(option.value || option)}
                onChange={onChange}
                className="form-checkbox h-4 w-4 text-purple-600 rounded"
                disabled={disabled}
              />
              <span className="ml-2">{safeRender(option.label || option)}</span>
            </label>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="mb-4">
      <label className="block text-gray-700 text-sm font-bold mb-2">{label}</label>
      <input
        type={type}
        value={String(processedValue || '')} // Explicitly convert to string and handle null/undefined
        onChange={(e) => {
          onChange(e);
        }}
        placeholder={placeholder}
        className={inputClasses}
        disabled={disabled}
        name={name}
      />
    </div>
  );
};

// Modal Component for messages and receipts
const Modal = ({ show, onClose, title, children }) => {
  if (!show) return null;

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-lg mx-auto p-6 relative">
        <h2 className="text-2xl font-bold mb-4 text-gray-800">{title}</h2>
        <button
          onClick={onClose}
          className="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl font-bold"
        >
          &times;
        </button>
        <div className="modal-content max-h-[70vh] overflow-y-auto">
          {children}
        </div>
      </div>
    </div>
  );
};

// New ConfirmationModal Component
const ConfirmationModal = ({ show, title, message, onConfirm, onCancel }) => {
  if (!show) return null;

  return (
    <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg shadow-xl w-full max-w-sm mx-auto p-6 relative text-center">
        <h2 className="text-2xl font-bold mb-4 text-gray-800">{title}</h2>
        <p className="text-gray-700 mb-6">{message}</p>
        <div className="flex justify-center gap-4">
          <Button onClick={onConfirm} className="bg-red-600 hover:bg-red-700 text-white">Sí, Eliminar</Button>
          <Button onClick={onCancel} className="bg-gray-500 hover:bg-gray-600">Cancelar</Button>
        </div>
      </div>
    </div>
  );
};


function App() {
  const [activeTab, setActiveTab] = useState('resumen'); // Changed initial tab to 'resumen'
  const [userId, setUserId] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [pdfLibsLoaded, setPdfLibsLoaded] = useState(false); // New state for PDF libraries
  const [successMessage, setSuccessMessage] = useState(null); // State for success messages
  const [errorMessage, setErrorMessage] = useState(null); // State for error messages

  // Report states - Moved to the top for proper initialization
  const [reportMonth, setReportMonth] = useState(new Date().getMonth() + 1);
  const [reportYear, setReportYear] = useState(new Date().getFullYear());
  const [pendingPaymentsReport, setPendingPaymentsReport] = useState([]); // Initialize with empty array

  // Propietarios State
  const [owners, setOwners] = useState([]);
  const [newOwner, setNewOwner] = useState({
    name: '', building: '', letter: '', apartment: '', floor: '',
    carMake: '', carModel: '', licensePlate: '', color: '', controlCode: '', observation: '',
    email: '', phone: '', condition: 'Operativo' // Added condition with default
  });
  const [otherCarMake, setOtherCarMake] = useState(''); // New state for 'Otro' car make
  const ownersTableRef = useRef(null); // Ref for owners table (visible in UI)
  const ownersPdfContentRef = useRef(null); // New ref for the hidden PDF content
  const ownersBlock2223PdfContentRef = useRef(null); // New ref for Block 22/23 owners PDF
  const ownersOtherBlocksPdfContentRef = useRef(null); // New ref for Other Blocks owners PDF
  const [selectedBuildingsFilter, setSelectedBuildingsFilter] = useState([]); // New state for building filter


  const [editingOwnerId, setEditingOwnerId] = useState(null); // State to hold the ID of the owner being edited

  // Pagos State
  const [payments, setPayments] = useState([]);
  // Updated initialPaymentDetail to include currency
  const initialPaymentDetail = { method: '', bank: '', reference: '', amount: '', currency: 'USD' };
  const [newPayment, setNewPayment] = useState({
    ownerId: '', date: '', concept: '', monthsPaid: [],
    paymentDetails: [initialPaymentDetail], // Array for multiple payment modalities within ONE logical payment
    receiptId: ''
  });
  const [showPaymentReceiptModal, setShowPaymentReceiptModal] = useState(false);
  const [currentPaymentReceipt, setCurrentPaymentReceipt] = useState(null);
  const paymentReceiptRef = useRef();
  const paymentsReportPdfContentRef = useRef(null); // Ref for payments report PDF content
  const paymentsBlock2223PdfContentRef = useRef(null); // New ref for Block 22/23 payments PDF
  const paymentsOtherBlocksPdfContentRef = useRef(null); // New ref for Other Blocks payments PDF


  // Gastos State
  const [expenses, setExpenses] = useState([]);
  const [newExpense, setNewExpense] = useState({
    date: '', concept: '', beneficiary: '', amount: '', currency: 'USD', method: '',
    commissionPercentage: '', commissionAmount: 0, totalToDebit: 0, receiptId: ''
  });
  const [editingExpenseId, setEditingExpenseId] = useState(null); // State to hold the ID of the expense being edited
  const [showExpenseReceiptModal, setShowExpenseReceiptModal] = useState(false);
  const [currentExpenseReceipt, setCurrentExpenseReceipt] = useState(null);
  const expenseReceiptRef = useRef();
  const expensesReportPdfContentRef = useRef(null); // Ref for expenses report PDF content


  // Compra de Divisas State
  const [currencyPurchases, setCurrencyPurchases] = useState([]);
  const [newCurrencyPurchase, setNewCurrencyPurchase] = useState({
    date: '', mechanism: '', amount: '', exchangeRate: '',
    countervalueBs: 0, commissionPercentage: '', commissionBs: 0, withdrawalCommission: '', totalToDebit: 0
  });

  const pendingPaymentsPdfContentRef = useRef(null); // Ref for pending payments PDF content
  const currencyPurchasesPdfContentRef = useRef(null); // Ref for currency purchases PDF content

  // NEW: Comercio State
  const [commercialPayments, setCommercialPayments] = useState([]);
  const [newCommercialPayment, setNewCommercialPayment] = useState({
    name: '', date: '', concept: '', monthsPaid: [],
    paymentDetails: [initialPaymentDetail], // Reusing initialPaymentDetail structure
    receiptId: ''
  });
  const [showCommercialPaymentReceiptModal, setShowCommercialPaymentReceiptModal] = useState(false);
  const [currentCommercialPaymentReceipt, setCurrentCommercialPaymentReceipt] = useState(null);
  const commercialPaymentReceiptRef = useRef();
  const commercialPaymentsReportPdfContentRef = useRef(null);


  // Recalculate Contravalor, Commission, and Total to Debit for Currency Purchase
  useEffect(() => {
    const amount = parseFloat(newCurrencyPurchase.amount) || 0;
    const exchangeRate = parseFloat(newCurrencyPurchase.exchangeRate) || 0;
    const commissionPercentage = parseFloat(newCurrencyPurchase.commissionPercentage) || 0;
    const withdrawalCommission = parseFloat(newCurrencyPurchase.withdrawalCommission) || 0;

    const calculatedCountervalueBs = amount * exchangeRate;
    const calculatedCommissionBs = calculatedCountervalueBs * (commissionPercentage / 100);
    const calculatedTotalToDebit = calculatedCountervalueBs + calculatedCommissionBs + withdrawalCommission;

    setNewCurrencyPurchase(prev => ({
      ...prev,
      countervalueBs: calculatedCountervalueBs,
      commissionBs: calculatedCommissionBs,
      totalToDebit: calculatedTotalToDebit
    }));
  }, [newCurrencyPurchase.amount, newCurrencyPurchase.exchangeRate, newCurrencyPurchase.commissionPercentage, newCurrencyPurchase.withdrawalCommission]);

  // Recalculate Commission and Total to Debit for Expenses (Pago Móvil)
  useEffect(() => {
    const amount = parseFloat(newExpense.amount) || 0;
    const commissionPercentage = parseFloat(newExpense.commissionPercentage) || 0;

    let calculatedCommissionAmount = 0;
    let calculatedTotalToDebit = amount;

    if (newExpense.method === 'Pago Móvil') {
      calculatedCommissionAmount = amount * (commissionPercentage / 100);
      calculatedTotalToDebit = amount + calculatedCommissionAmount;
    }

    setNewExpense(prev => ({
      ...prev,
      commissionAmount: calculatedCommissionAmount,
      totalToDebit: calculatedTotalToDebit
    }));
  }, [newExpense.amount, newExpense.commissionPercentage, newExpense.method]);


  // Confirmation Modal State
  const [showConfirmationModal, setShowConfirmationModal] = useState(false);
  const [itemToDeleteId, setItemToDeleteId] = useState(null);
  const [itemToDeleteType, setItemToDeleteType] = useState(null); // 'owner', 'expense', or 'currencyPurchase'


  // Effect to clear messages after a few seconds
  useEffect(() => {
    if (successMessage) {
      const timer = setTimeout(() => setSuccessMessage(null), 5000);
      return () => clearTimeout(timer);
    }
    if (errorMessage) {
      const timer = setTimeout(() => setErrorMessage(null), 5000);
      return () => clearTimeout(timer);
    }
  }, [successMessage, errorMessage]);

  // --- Firebase Initialization and Auth ---
  useEffect(() => {
    const initializeAuth = async () => {
      try {
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }
      } catch (e) {
        console.error("Error during Firebase authentication:", e);
        setErrorMessage("Error al autenticar con Firebase.");
      }
    };

    const unsubscribe = onAuthStateChanged(auth, (user) => {
      if (user) {
        setUserId(user.uid);
        setLoading(false);
      } else {
        setUserId(null);
        setLoading(false);
        initializeAuth(); // Attempt to authenticate if not already
      }
    });

    return () => unsubscribe();
  }, []); // Run only once on component mount

  // --- Load PDF Libraries from CDN ---
  useEffect(() => {
    const loadScript = (src, id, callback) => {
      if (document.getElementById(id)) {
        callback();
        return;
      }
      const script = document.createElement('script');
      script.src = src;
      script.id = id;
      script.onload = callback;
      script.onerror = () => {
        console.error(`Failed to load script: ${src}`);
        setErrorMessage(`Error al cargar librería: ${src.split('/').pop().split('.')[0]}.`);
      };
      document.body.appendChild(script);
    };

    let html2canvasLoaded = false;
    let jspdfLoaded = false;

    const checkAllLoaded = () => {
      if (html2canvasLoaded && jspdfLoaded) {
        setPdfLibsLoaded(true);
      }
    };

    loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js', 'html2canvas-script', () => {
      html2canvasLoaded = true;
      checkAllLoaded();
    });
    loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js', 'jspdf-script', () => {
      jspdfLoaded = true;
      checkAllLoaded();
    });

    // Cleanup function to remove scripts if component unmounts
    return () => {
      const html2canvasScript = document.getElementById('html22canvas-script');
      if (html2canvasScript) document.body.removeChild(html2canvasScript);
      const jspdfScript = document.getElementById('jspdf-script');
      if (jspdfScript) document.body.removeChild(jspdfScript);
    };
  }, []); // Run once on mount

  // --- Firestore Data Fetching ---
  useEffect(() => {
    if (!userId) return;

    // Fetch Owners
    const ownersCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/owners`);
    const unsubscribeOwners = onSnapshot(ownersCollectionRef, (snapshot) => {
      const ownersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setOwners(ownersData);
    }, (err) => {
      console.error("Error fetching owners:", err);
      setErrorMessage("Error al cargar propietarios.");
    });

    // Fetch Payments
    const paymentsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/payments`);
    const unsubscribePayments = onSnapshot(paymentsCollectionRef, (snapshot) => {
      const paymentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setPayments(paymentsData);
    }, (err) => {
      console.error("Error fetching payments:", err);
      setErrorMessage("Error al cargar pagos.");
    });

    // Fetch Expenses
    const expensesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/expenses`);
    const unsubscribeExpenses = onSnapshot(expensesCollectionRef, (snapshot) => {
      const expensesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setExpenses(expensesData);
    }, (err) => {
      console.error("Error fetching expenses:", err);
      setErrorMessage("Error al cargar gastos.");
    });

    // Fetch Currency Purchases
    const currencyPurchasesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/currency_purchases`);
    const unsubscribeCurrencyPurchases = onSnapshot(currencyPurchasesCollectionRef, (snapshot) => {
      const purchasesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setCurrencyPurchases(purchasesData);
    }, (err) => {
      console.error("Error fetching currency purchases:", err);
      setErrorMessage("Error al cargar compras de divisas.");
    });

    // NEW: Fetch Commercial Payments
    const commercialPaymentsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/commercial_payments`);
    const unsubscribeCommercialPayments = onSnapshot(commercialPaymentsCollectionRef, (snapshot) => {
      const commercialPaymentsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setCommercialPayments(commercialPaymentsData);
    }, (err) => {
      console.error("Error fetching commercial payments:", err);
      setErrorMessage("Error al cargar pagos de comercios.");
    });


    return () => {
      unsubscribeOwners();
      unsubscribePayments();
      unsubscribeExpenses();
      unsubscribeCurrencyPurchases();
      unsubscribeCommercialPayments(); // Cleanup for new collection
    };
  }, [userId]); // Re-run when userId changes

  // --- Owner Management ---
  const handleOwnerChange = (e) => {
    const { name, value } = e.target;
    setNewOwner(prev => ({ ...prev, [name]: value }));

    if (name === 'carMake') {
      // If "Otro" is selected, clear otherCarMake for fresh input
      if (value === 'Otro') {
        setOtherCarMake('');
        setNewOwner(prev => ({ ...prev, carModel: '' })); // Clear carModel when 'Otro' is selected
      } else {
        // If a specific make is selected, set a default model or clear if no models
        const models = carData[value] || [];
        setNewOwner(prev => ({ ...prev, carModel: models.length > 0 ? models[0] : '' }));
        setOtherCarMake(''); // Clear otherCarMake if not 'Otro'
      }
    }
  };

  const handleOtherCarMakeChange = (e) => {
    setOtherCarMake(e.target.value);
    // When 'otherCarMake' is changed, ensure 'carMake' in newOwner is also updated to this value
    setNewOwner(prev => ({ ...prev, carMake: e.target.value }));
  };


  const handleEditOwner = (owner) => {
    setNewOwner({ ...owner }); // Load owner data into the form
    // If the carMake from owner is not in carData, assume it's an "Otro" type
    if (!Object.keys(carData).includes(owner.carMake)) { // Check if carMake exists in predefined list
      setNewOwner(prev => ({ ...prev, carMake: 'Otro' }));
      setOtherCarMake(owner.carMake);
    } else {
      setOtherCarMake(''); // Clear if not "Otro"
    }
    setEditingOwnerId(owner.id); // Set the ID of the owner being edited
  };

  const cancelEditOwner = () => {
    setNewOwner({ // Clear the form
      name: '', building: '', letter: '', apartment: '', floor: '',
      carMake: '', carModel: '', licensePlate: '', color: '', controlCode: '', observation: '',
      email: '', phone: '', condition: 'Operativo' // Reset condition
    });
    setOtherCarMake(''); // Clear other car make field
    setEditingOwnerId(null); // Clear editing state
    setErrorMessage(null); // Clear any error message
  };

  const addOrUpdateOwner = async () => {
    if (!userId) {
      setErrorMessage("Usuario no autenticado. Por favor, intente de nuevo.");
      return;
    }
    if (!newOwner.name || !newOwner.building || !newOwner.apartment) {
      setErrorMessage("Por favor, complete los campos obligatorios: Nombre, Edificio, Apartamento.");
      return;
    }

    // Determine the final carMake value to save
    const finalCarMake = newOwner.carMake === 'Otro' ? otherCarMake : newOwner.carMake;
    if (newOwner.carMake === 'Otro' && !otherCarMake) {
      setErrorMessage("Por favor, especifique la marca de vehículo 'Otro'.");
      return;
    }

    try {
      const ownerToSave = { ...newOwner, carMake: finalCarMake };

      if (editingOwnerId) {
        // Update existing owner
        const ownerRef = doc(db, `artifacts/${appId}/users/${userId}/owners`, editingOwnerId);
        await updateDoc(ownerRef, ownerToSave);
        setSuccessMessage("Propietario actualizado con éxito!");
      } else {
        // Add new owner
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/owners`), ownerToSave);
        setSuccessMessage("Propietario añadido con éxito!");
      }
      // Clear form and editing state after success
      setNewOwner({
        name: '', building: '', letter: '', apartment: '', floor: '',
        carMake: '', carModel: '', licensePlate: '', color: '', controlCode: '', observation: '',
        email: '', phone: '', condition: 'Operativo'
      });
      setOtherCarMake(''); // Clear other car make field
      setEditingOwnerId(null);
      setErrorMessage(null); // Clear any previous error
    } catch (e) {
      console.error("Error al guardar propietario: ", e);
      setErrorMessage("Error al guardar propietario.");
    }
  };

  // Modified deleteOwner to use ConfirmationModal
  const deleteOwner = (id) => {
    setItemToDeleteId(id);
    setItemToDeleteType('owner');
    setShowConfirmationModal(true);
  };

  // --- Payment Management ---
  const handlePaymentChange = (e) => {
    const { name, value, checked, type } = e.target;

    if (name === 'monthsPaid' && type === 'checkbox') {
      setNewPayment(prev => {
        const currentMonths = Array.isArray(prev.monthsPaid) ? [...prev.monthsPaid] : [];
        if (checked) {
          // Add the month-year string, maintaining order based on month index and then year
          const newMonths = [...currentMonths, value].sort((a, b) => {
            const [monthA, yearA] = a.split('-');
            const [monthB, yearB] = b.split('-');
            const monthIndexA = monthsOfYear.indexOf(monthA);
            const monthIndexB = monthsOfYear.indexOf(monthB);

            if (yearA !== yearB) {
              return parseInt(yearA) - parseInt(yearB);
            }
            return monthIndexA - monthIndexB;
          });
          return { ...prev, monthsPaid: newMonths };
        } else {
          return { ...prev, monthsPaid: currentMonths.filter(monthYear => monthYear !== value) };
        }
      });
    } else {
      setNewPayment(prev => ({ ...prev, [name]: value }));
    }
  };

  // Handles changes for individual payment entries within paymentDetails array
  const handlePaymentDetailChange = (index, e) => {
    const { name, value } = e.target;
    setNewPayment(prev => {
      const updatedDetails = [...prev.paymentDetails];
      updatedDetails[index] = { ...updatedDetails[index], [name]: value };
      // If method changes, clear bank and reference if not applicable
      if (name === 'method') {
        if (!['Pago Móvil', 'Transferencia'].includes(value)) {
          updatedDetails[index].bank = '';
          updatedDetails[index].reference = '';
        }
      }
      return { ...prev, paymentDetails: updatedDetails };
    });
  };

  const addPaymentDetail = () => {
    setNewPayment(prev => ({
      ...prev,
      paymentDetails: [...prev.paymentDetails, { ...initialPaymentDetail }]
    }));
  };

  const removePaymentDetail = (indexToRemove) => {
    setNewPayment(prev => ({
      ...prev,
      paymentDetails: prev.paymentDetails.filter((_, index) => index !== indexToRemove)
    }));
  };


  const addPayment = async () => {
    if (!userId) {
      setErrorMessage("Usuario no autenticado. Por favor, intente de nuevo.");
      return;
    }
    // Basic validation for main payment fields
    if (!newPayment.ownerId || !newPayment.date || !newPayment.concept || newPayment.paymentDetails.length === 0) {
      setErrorMessage("Por favor, complete los campos obligatorios principales: Propietario, Fecha, Concepto y al menos un detalle de pago.");
      return;
    }

    // Validate each payment detail entry
    const invalidDetails = newPayment.paymentDetails.some(detail => {
      if (!detail.method || !detail.amount || parseFloat(detail.amount) <= 0 || !detail.currency) { // Added currency validation
        return true; // Method, amount, or currency is missing/invalid
      }
      if (['Pago Móvil', 'Transferencia'].includes(detail.method) && (!detail.bank || !detail.reference)) {
        return true; // Bank or reference is missing for these methods
      }
      return false;
    });

    if (invalidDetails) {
      setErrorMessage("Por favor, complete todos los campos obligatorios para cada detalle de pago (Modalidad, Monto, Moneda, Banco/Referencia si aplica).");
      return;
    }

    if (newPayment.concept === 'Pago de Mensualidad' && (!newPayment.monthsPaid || newPayment.monthsPaid.length === 0)) {
      setErrorMessage("Por favor, seleccione al menos un mes para el pago de mensualidad.");
      return;
    }

    try {
      // Generate a unique receipt ID
      const timestamp = new Date().getTime();
      const randomString = Math.random().toString(36).substring(2, 8); // Short random string
      const generatedReceiptId = `REC-${timestamp}-${randomString}`.toUpperCase();

      await addDoc(collection(db, `artifacts/${appId}/users/${userId}/payments`), {
        ownerId: newPayment.ownerId,
        date: newPayment.date,
        concept: newPayment.concept,
        monthsPaid: newPayment.monthsPaid,
        paymentDetails: newPayment.paymentDetails.map(detail => ({ // Ensure amounts are numbers
          ...detail,
          amount: parseFloat(detail.amount) || 0
        })),
        receiptId: generatedReceiptId
      });
      // Clear form after successful submission
      setNewPayment({
        ownerId: '', date: '', concept: '', monthsPaid: [],
        paymentDetails: [initialPaymentDetail], // Reset to one empty detail
        receiptId: ''
      });
      setSuccessMessage("Pago registrado con éxito!");
      setErrorMessage(null); // Clear any previous error
    } catch (e) {
      console.error("Error adding payment: ", e);
      setErrorMessage("Error al añadir pago.");
    }
  };

  const generatePaymentReceipt = (payment) => {
    const owner = owners.find(o => o.id === payment.ownerId);
    setCurrentPaymentReceipt({ payment, owner });
    setShowPaymentReceiptModal(true);
  };

  // --- Expense Management ---
  const handleExpenseChange = (e) => {
    const { name, value } = e.target;
    setNewExpense(prev => ({ ...prev, [name]: value }));
  };

  const handleEditExpense = (expense) => {
    setNewExpense({ ...expense }); // Load expense data into the form
    setEditingExpenseId(expense.id); // Set the ID of the expense being edited
  };

  const cancelEditExpense = () => {
    setNewExpense({ // Clear the form
      date: '', concept: '', beneficiary: '', amount: '', currency: 'USD', method: '',
      commissionPercentage: '', commissionAmount: 0, totalToDebit: 0, receiptId: ''
    });
    setEditingExpenseId(null); // Clear editing state
    setErrorMessage(null); // Clear any error message
  };

  const addOrUpdateExpense = async () => {
    if (!userId) {
      setErrorMessage("Usuario no autenticado. Por favor, intente de nuevo.");
      return;
    }
    if (!newExpense.date || !newExpense.concept || !newExpense.beneficiary || !newExpense.amount || !newExpense.method) {
      setErrorMessage("Por favor, complete los campos obligatorios: Fecha, Concepto, Beneficiario, Monto, Modalidad.");
      return;
    }

    const expenseToSave = {
      ...newExpense,
      amount: parseFloat(newExpense.amount) || 0, // Ensure it's a number, default to 0 if NaN or empty
      commissionPercentage: parseFloat(newExpense.commissionPercentage) || 0,
      commissionAmount: parseFloat(newExpense.commissionAmount) || 0,
      totalToDebit: parseFloat(newExpense.totalToDebit) || 0,
    };

    if (isNaN(expenseToSave.amount)) {
      setErrorMessage("El monto del gasto debe ser un número válido.");
      return;
    }

    try {
      if (editingExpenseId) {
        // Update existing expense
        const expenseRef = doc(db, `artifacts/${appId}/users/${userId}/expenses`, editingExpenseId);
        await updateDoc(expenseRef, expenseToSave);
        setSuccessMessage("Gasto actualizado con éxito!");
      } else {
        // Add new expense
        const timestamp = new Date().getTime();
        const randomString = Math.random().toString(36).substring(2, 8); // Short random string
        const generatedReceiptId = `EXP-${timestamp}-${randomString}`.toUpperCase();

        const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/expenses`), {
          ...expenseToSave,
          receiptId: generatedReceiptId // Store the generated receipt ID
        });
        setSuccessMessage("Gasto añadido con éxito!");
      }
      setNewExpense({
        date: '', concept: '', beneficiary: '', amount: '', currency: 'USD', method: '',
        commissionPercentage: '', commissionAmount: 0, totalToDebit: 0, receiptId: ''
      });
      setEditingExpenseId(null); // Clear editing state
      setErrorMessage(null); // Clear any previous error
    } catch (e) {
      console.error("Error al guardar gasto: ", e);
      setErrorMessage("Error al guardar gasto: " + (e.message || e.toString()));
    }
  };

  // Modified deleteExpense to use ConfirmationModal
  const deleteExpense = (id) => {
    setItemToDeleteId(id);
    setItemToDeleteType('expense');
    setShowConfirmationModal(true);
  };

  // --- Currency Purchase Management ---
  const handleCurrencyPurchaseChange = (e) => {
    const { name, value } = e.target;
    setNewCurrencyPurchase(prev => ({ ...prev, [name]: value }));
  };

  const addCurrencyPurchase = async () => {
    if (!userId) {
      setErrorMessage("Usuario no autenticado. Por favor, intente de nuevo.");
      return;
    }
    if (!newCurrencyPurchase.date || !newCurrencyPurchase.mechanism || !newCurrencyPurchase.amount || !newCurrencyPurchase.exchangeRate) {
      setErrorMessage("Por favor, complete los campos obligatorios de compra de divisas: Fecha, Mecanismo, Monto, Tipo de Cambio.");
      return;
    }

    try {
      // 1. Add the currency purchase
      await addDoc(collection(db, `artifacts/${appId}/users/${userId}/currency_purchases`), {
        date: newCurrencyPurchase.date,
        mechanism: newCurrencyPurchase.mechanism,
        amount: parseFloat(newCurrencyPurchase.amount) || 0,
        exchangeRate: parseFloat(newCurrencyPurchase.exchangeRate) || 0,
        countervalueBs: parseFloat(newCurrencyPurchase.countervalueBs) || 0,
        commissionPercentage: parseFloat(newCurrencyPurchase.commissionPercentage) || 0,
        commissionBs: parseFloat(newCurrencyPurchase.commissionBs) || 0,
        withdrawalCommission: parseFloat(newCurrencyPurchase.withdrawalCommission) || 0,
        totalToDebit: parseFloat(newCurrencyPurchase.totalToDebit) || 0,
      });

      // 2. Automatically create an associated expense entry
      const timestamp = new Date().getTime();
      const randomString = Math.random().toString(36).substring(2, 8);
      const generatedExpenseReceiptId = `EXP-CURRENCY-${timestamp}-${randomString}`.toUpperCase();

      const autoExpense = {
        date: newCurrencyPurchase.date,
        concept: 'Compra de divisas',
        beneficiary: 'Estacionamiento',
        amount: parseFloat(newCurrencyPurchase.totalToDebit) || 0, // Use totalToDebit as the amount for the expense
        currency: 'Bolívares', // The totalToDebit is in Bolívares
        method: 'Débito en cuenta',
        commissionPercentage: 0, // No commission for this auto-generated expense
        commissionAmount: 0,
        totalToDebit: parseFloat(newCurrencyPurchase.totalToDebit) || 0, // Same as amount for this type of expense
        receiptId: generatedExpenseReceiptId
      };

      await addDoc(collection(db, `artifacts/${appId}/users/${userId}/expenses`), autoExpense);


      setSuccessMessage("Compra de divisas y gasto asociado registrados con éxito!");
      setNewCurrencyPurchase({
        date: '', mechanism: '', amount: '', exchangeRate: '',
        countervalueBs: 0, commissionPercentage: '', commissionBs: 0, withdrawalCommission: '', totalToDebit: 0
      });
      setErrorMessage(null);
    } catch (e) {
      console.error("Error adding currency purchase or associated expense: ", e);
      setErrorMessage("Error al añadir compra de divisas o gasto asociado.");
    }
  };

  // NEW: Commercial Payment Management
  const handleCommercialPaymentChange = (e) => {
    const { name, value, checked, type } = e.target;

    if (name === 'monthsPaid' && type === 'checkbox') {
      setNewCommercialPayment(prev => {
        const currentMonths = Array.isArray(prev.monthsPaid) ? [...prev.monthsPaid] : [];
        if (checked) {
          const newMonths = [...currentMonths, value].sort((a, b) => {
            const [monthA, yearA] = a.split('-');
            const [monthB, yearB] = b.split('-');
            const monthIndexA = monthsOfYear.indexOf(monthA);
            const monthIndexB = monthsOfYear.indexOf(monthB);

            if (yearA !== yearB) {
              return parseInt(yearA) - parseInt(yearB);
            }
            return monthIndexA - monthIndexB;
          });
          return { ...prev, monthsPaid: newMonths };
        } else {
          return { ...prev, monthsPaid: currentMonths.filter(monthYear => monthYear !== value) };
        }
      });
    } else {
      setNewCommercialPayment(prev => ({ ...prev, [name]: value }));
    }
  };

  const handleCommercialPaymentDetailChange = (index, e) => {
    const { name, value } = e.target;
    setNewCommercialPayment(prev => {
      const updatedDetails = [...prev.paymentDetails];
      updatedDetails[index] = { ...updatedDetails[index], [name]: value };
      if (name === 'method') {
        if (!['Pago Móvil', 'Transferencia'].includes(value)) {
          updatedDetails[index].bank = '';
          updatedDetails[index].reference = '';
        }
      }
      return { ...prev, paymentDetails: updatedDetails };
    });
  };

  const addCommercialPaymentDetail = () => {
    setNewCommercialPayment(prev => ({
      ...prev,
      paymentDetails: [...prev.paymentDetails, { ...initialPaymentDetail }]
    }));
  };

  const removeCommercialPaymentDetail = (indexToRemove) => {
    setNewCommercialPayment(prev => ({
      ...prev,
      paymentDetails: prev.paymentDetails.filter((_, index) => index !== indexToRemove)
    }));
  };

  const addCommercialPayment = async () => {
    if (!userId) {
      setErrorMessage("Usuario no autenticado. Por favor, intente de nuevo.");
      return;
    }
    if (!newCommercialPayment.name || !newCommercialPayment.date || !newCommercialPayment.concept || newCommercialPayment.paymentDetails.length === 0) {
      setErrorMessage("Por favor, complete los campos obligatorios principales: Nombre del Comercio, Fecha, Concepto y al menos un detalle de pago.");
      return;
    }

    const invalidDetails = newCommercialPayment.paymentDetails.some(detail => {
      if (!detail.method || !detail.amount || parseFloat(detail.amount) <= 0 || !detail.currency) {
        return true;
      }
      if (['Pago Móvil', 'Transferencia'].includes(detail.method) && (!detail.bank || !detail.reference)) {
        return true;
      }
      return false;
    });

    if (invalidDetails) {
      setErrorMessage("Por favor, complete todos los campos obligatorios para cada detalle de pago (Modalidad, Monto, Moneda, Banco/Referencia si aplica).");
      return;
    }

    if (newCommercialPayment.concept === 'Aporte Mensual' && (!newCommercialPayment.monthsPaid || newCommercialPayment.monthsPaid.length === 0)) {
      setErrorMessage("Por favor, seleccione al menos un mes para el aporte mensual.");
      return;
    }

    try {
      const timestamp = new Date().getTime();
      const randomString = Math.random().toString(36).substring(2, 8);
      const generatedReceiptId = `COMM-REC-${timestamp}-${randomString}`.toUpperCase();

      await addDoc(collection(db, `artifacts/${appId}/users/${userId}/commercial_payments`), {
        name: newCommercialPayment.name,
        date: newCommercialPayment.date,
        concept: newCommercialPayment.concept,
        monthsPaid: newCommercialPayment.monthsPaid,
        paymentDetails: newCommercialPayment.paymentDetails.map(detail => ({
          ...detail,
          amount: parseFloat(detail.amount) || 0
        })),
        receiptId: generatedReceiptId
      });
      setSuccessMessage("Pago de comercio registrado con éxito!");
      setNewCommercialPayment({
        name: '', date: '', concept: '', monthsPaid: [],
        paymentDetails: [initialPaymentDetail],
        receiptId: ''
      });
      setErrorMessage(null);
    } catch (e) {
      console.error("Error adding commercial payment: ", e);
      setErrorMessage("Error al añadir pago de comercio.");
    }
  };

  const generateCommercialPaymentReceipt = (payment) => {
    setCurrentCommercialPaymentReceipt(payment);
    setShowCommercialPaymentReceiptModal(true);
  };


  // Centralized deletion logic after confirmation
  const handleConfirmDeletion = async () => {
    setShowConfirmationModal(false); // Close the modal
    if (!userId) {
      setErrorMessage("Usuario no autenticado. No se puede eliminar.");
      return;
    }

    try {
      if (itemToDeleteType === 'owner') {
        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/owners`, itemToDeleteId));
        setSuccessMessage("Propietario eliminado con éxito!");
      } else if (itemToDeleteType === 'expense') {
        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/expenses`, itemToDeleteId));
        setSuccessMessage("Gasto eliminado con éxito!");
      }
      setErrorMessage(null); // Clear any previous error
    } catch (e) {
      console.error(`Error deleting ${itemToDeleteType}: `, e);
      setErrorMessage(`Error al eliminar ${itemToDeleteType}: ${e.message || e.toString()}`);
    } finally {
      setItemToDeleteId(null);
      setItemToDeleteType(null);
    }
  };

  const handleCancelDeletion = () => {
    setShowConfirmationModal(false);
    setItemToDeleteId(null);
    setItemToDeleteType(null);
  };

  const generateExpenseReceipt = (expense) => {
    setCurrentExpenseReceipt(expense);
    setShowExpenseReceiptModal(true);
  };

  // --- CSV/Excel Download Utility ---
  const downloadCSV = (data, filename) => {
    if (!data || data.length === 0) {
      setErrorMessage("No hay datos para descargar.");
      return;
    }
    const headers = Object.keys(data[0]);
    const csvContent = [
      headers.join(','),
      ...data.map(row => headers.map(fieldName => JSON.stringify(row[fieldName])).join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      document.body.removeChild(link);
    }
  };

  // --- PDF Single Page Download Utility ---
  const downloadPDF = async (elementRef, filename, dataToRender = null, title = '') => {
    if (!pdfLibsLoaded) {
      setErrorMessage("Las librerías de PDF no se han cargado completamente. Por favor, espere un momento.");
      return;
    }
    if (!elementRef.current && !dataToRender) { // Check dataToRender as well
      setErrorMessage("No se encontró el contenido para generar el PDF. Asegúrese de que el elemento esté visible y montado en el DOM.");
      return;
    }

    // Temporarily render content for PDF if dataToRender is provided
    let tempDiv = null;
    if (dataToRender) {
      tempDiv = document.createElement('div');
      tempDiv.style.position = 'absolute';
      tempDiv.style.left = '-9999px';
      tempDiv.style.width = '100%';
      tempDiv.style.padding = '1rem';
      tempDiv.style.backgroundColor = 'white';
      document.body.appendChild(tempDiv);

      // Render the table content into the temporary div based on the type of data
      let tableHtml = '';
      // Common styles for table, thead, th, tbody, tr, td
      const tableStyle = `min-width: 100%; border-collapse: collapse; border: 1px solid #d1d5db; font-family: 'Inter', sans-serif;`;
      // Changed header background to a shade of green
      const thStyle = `padding: 0.75rem 0.5rem; border: 1px solid #d1d5db; text-align: center; font-size: 10px; font-weight: bold; color: white; background-color: #059669; white-space: nowrap;`; // Emerald green header
      const tdStyle = `padding: 0.5rem 0.5rem; border: 1px solid #d1d5db; text-align: center; font-size: 9px; white-space: nowrap;`;
      const trEvenStyle = `background-color: white;`;
      const trOddStyle = `background-color: #f9fafb;`; // Light gray for odd rows
      const tfootStyle = `background-color: #e5e7eb; font-weight: bold;`; // Slightly darker gray for footer

      // Changed title background to a lighter shade of green
      const titleBgColor = '#D1FAE5'; // Light emerald green

      // Ensure dataToRender is an array before mapping
      const dataToUse = Array.isArray(dataToRender) ? dataToRender : [];


      if (title.includes('Propietarios')) {
        tableHtml = `
          <h3 style="font-size: 1.25rem; font-weight: bold; text-align: center; margin-bottom: 1rem; padding: 0.5rem; background-color: ${titleBgColor}; color: #1f2937; border-radius: 0.375rem;">${title}</h3>
          <table style="${tableStyle}">
            <thead>
              <tr style="background-color: #059669; color: white;">
                <th style="${thStyle}">Edificio</th><th style="${thStyle}">Letra</th><th style="${thStyle}">Apto</th><th style="${thStyle}">Nombre</th><th style="${thStyle}">Vehículo</th><th style="${thStyle}">Color</th><th style="${thStyle}">Condición</th><th style="${thStyle}">Correo</th><th style="${thStyle}">Teléfono</th><th style="${thStyle}">Código Control</th>
              </tr>
            </thead>
            <tbody>
              ${dataToUse.length === 0 ? `
                <tr>
                  <td colSpan="10" style="${tdStyle} color: #6b7280;">No hay propietarios registrados.</td>
                </tr>
              ` : dataToUse.map((owner, index) => `
                <tr style="${index % 2 === 0 ? trEvenStyle : trOddStyle}">
                  <td style="${tdStyle}">${safeRender(owner.building)}</td>
                  <td style="${tdStyle}">${safeRender(owner.letter)}</td>
                  <td style="${tdStyle}">${safeRender(owner.apartment)}</td>
                  <td style="${tdStyle}">${safeRender(owner.name)}</td>
                  <td style="${tdStyle}">${safeRender(owner.carMake)} ${safeRender(owner.carModel)}</td>
                  <td style="${tdStyle}">${safeRender(owner.color)}</td>
                  <td style="${tdStyle}">${safeRender(owner.condition)}</td>
                  <td style="${tdStyle}">${safeRender(owner.email)}</td>
                  <td style="${tdStyle}">${safeRender(owner.phone)}</td>
                  <td style="${tdStyle} font-weight: bold;">${safeRender(owner.controlCode)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } else if (title.includes('Pagos Mensual') && !title.includes('Comercios')) {
        tableHtml = `
          <h3 style="font-size: 1.25rem; font-weight: bold; text-align: center; margin-bottom: 1rem; padding: 0.5rem; background-color: ${titleBgColor}; color: #1f2937; border-radius: 0.375rem;">${title}</h3>
          <table style="${tableStyle}">
            <thead>
              <tr style="background-color: #059669; color: white;">
                <th style="${thStyle}">Edificio</th><th style="${thStyle}">Letra</th><th style="${thStyle}">Apto</th><th style="${thStyle}">Nombre</th><th style="${thStyle}">Vehículo</th><th style="${thStyle} text-align: right;">Monto USD</th><th style="${thStyle} text-align: right;">Monto Bs.</th><th style="${thStyle}">Fecha</th><th style="${thStyle}">Concepto</th>
              </tr>
            </thead>
            <tbody>
              ${dataToUse.length === 0 ? `
                <tr>
                  <td colSpan="9" style="${tdStyle} color: #6b7280;">No hay pagos para este mes.</td>
                </tr>
              ` : dataToUse.map((payment, index) => {
                const owner = owners.find(o => o.id === payment.ownerId);
                const vehicleInfo = owner ? `${safeRender(owner.carMake)} ${safeRender(owner.carModel)}` : 'N/A';
                const conceptDisplay = payment.concept === 'Pago de Mensualidad' && payment.monthsPaid && payment.monthsPaid.length > 0
                  ? `${safeRender(payment.concept)} (${safeRender(payment.monthsPaid)})`
                  : safeRender(payment.concept);

                let totalUSD = 0;
                let totalBs = 0;

                (payment.paymentDetails || []).forEach(detail => { // Safely access paymentDetails
                  if (detail.currency === 'USD') {
                    totalUSD += parseFloat(detail.amount) || 0;
                  }
                  if (detail.currency === 'Bolívares') {
                    totalBs += parseFloat(detail.amount) || 0;
                  }
                });

                return `
                  <tr style="${index % 2 === 0 ? trEvenStyle : trOddStyle}">
                    <td style="${tdStyle}">${owner ? safeRender(owner.building) : 'N/A'}</td>
                    <td style="${tdStyle}">${owner ? safeRender(owner.letter) : 'N/A'}</td>
                    <td style="${tdStyle}">${owner ? safeRender(owner.apartment) : 'N/A'}</td>
                    <td style="${tdStyle}">${owner ? safeRender(owner.name) : 'N/A'}</td>
                    <td style="${tdStyle}">${vehicleInfo}</td>
                    <td style="${tdStyle} text-align: right;">${formatNumber(totalUSD)}</td>
                    <td style="${tdStyle} text-align: right;">${formatNumber(totalBs)}</td>
                    <td style="${tdStyle}">${formatDate(payment.date)}</td>
                    <td style="${tdStyle} font-size: 9px;">${conceptDisplay}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
            <tfoot>
              <tr style="${tfootStyle}">
                <td colSpan="5" style="${tdStyle} text-align: right; font-weight: bold;">Total del Mes:</td>
                <td style="${tdStyle} text-align: right; font-weight: bold;">
                  ${formatNumber(dataToUse.reduce((sum, p) => sum + (p.paymentDetails || []).reduce((s, d) => s + (d.currency === 'USD' ? (parseFloat(d.amount) || 0) : 0), 0), 0))}
                </td>
                <td style="${tdStyle} text-align: right; font-weight: bold;">
                  ${formatNumber(dataToUse.reduce((sum, p) => sum + (p.paymentDetails || []).reduce((s, d) => s + (d.currency === 'Bolívares' ? (parseFloat(d.amount) || 0) : 0), 0), 0))}
                </td>
                <td colSpan="2" style="${tdStyle}"></td>
              </tr>
            </tfoot>
          </table>
        `;
      } else if (title.includes('Compras de Divisas')) {
        tableHtml = `
          <h3 style="font-size: 1.25rem; font-weight: bold; text-align: center; margin-bottom: 1rem; padding: 0.5rem; background-color: ${titleBgColor}; color: #1f2937; border-radius: 0.375rem;">${title}</h3>
          <table style="${tableStyle}">
            <thead>
              <tr style="background-color: #059669; color: white;">
                <th style="${thStyle}">Fecha</th><th style="${thStyle}">Mecanismo</th><th style="${thStyle} text-align: right;">Monto USD</th><th style="${thStyle} text-align: right;">Tasa</th><th style="${thStyle} text-align: right;">Contravalor Bs.</th><th style="${thStyle} text-align: right;">Comisión Bs.</th><th style="${thStyle} text-align: right;">Retiro Bs.</th><th style="${thStyle} text-align: right;">Total a Debitar Bs.</th>
              </tr>
            </thead>
            <tbody>
              ${dataToUse.length === 0 ? `
                <tr>
                  <td colSpan="8" style="${tdStyle} color: #6b7280;">No hay compras de divisas para este mes.</td>
                </tr>
              ` : dataToUse.map((purchase, index) => `
                <tr style="${index % 2 === 0 ? trEvenStyle : trOddStyle}">
                  <td style="${tdStyle}">${formatDate(purchase.date)}</td>
                  <td style="${tdStyle}">${safeRender(purchase.mechanism)}</td>
                  <td style="${tdStyle} text-align: right;">USD ${formatNumber(purchase.amount)}</td>
                  <td style="${tdStyle} text-align: right;">${formatNumber(purchase.exchangeRate)}</td>
                  <td style="${tdStyle} text-align: right;">Bs. ${formatNumber(purchase.countervalueBs)}</td>
                  <td style="${tdStyle} text-align: right;">Bs. ${formatNumber(purchase.commissionBs)}</td>
                  <td style="${tdStyle} text-align: right;">Bs. ${formatNumber(purchase.withdrawalCommission)}</td>
                  <td style="${tdStyle} text-align: right;">Bs. ${formatNumber(purchase.totalToDebit)}</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr style="${tfootStyle}">
                <td colSpan="2" style="${tdStyle} text-align: right; font-weight: bold;">Total del Mes:</td>
                <td style="${tdStyle} text-align: right; font-weight: bold;">
                  ${formatNumber(dataToUse.reduce((sum, cp) => sum + (parseFloat(cp.amount) || 0), 0))}
                </td>
                <td colSpan="4" style="${tdStyle}"></td>
                <td style="${tdStyle} text-align: right; font-weight: bold;">
                  Bs. ${formatNumber(dataToUse.reduce((sum, cp) => sum + (parseFloat(cp.totalToDebit) || 0), 0))}
                </td>
              </tr>
            </tfoot>
          </table>
        `;
      } else if (title.includes('Pagos Pendientes')) {
        tableHtml = `
          <h3 style="font-size: 1.25rem; font-weight: bold; text-align: center; margin-bottom: 1rem; padding: 0.5rem; background-color: ${titleBgColor}; color: #1f2937; border-radius: 0.375rem;">${title}</h3>
          <table style="${tableStyle}">
            <thead>
              <tr style="background-color: #059669; color: white;">
                <th style="${thStyle}">Propietario</th><th style="${thStyle}">Edificio</th><th style="${thStyle}">Letra</th><th style="${thStyle}">Apto</th><th style="${thStyle}">Vehículo</th><th style="${thStyle} text-align: right;">Monto Pendiente (USD)</th><th style="${thStyle}">Meses Pendientes</th>
              </tr>
            </thead>
            <tbody>
              ${dataToUse.length === 0 ? `
                <tr>
                  <td colSpan="7" style="${tdStyle} color: #6b7280;">No hay pagos pendientes para este período.</td>
                </tr>
              ` : dataToUse.map((item, index) => `
                <tr style="${index % 2 === 0 ? trEvenStyle : trOddStyle}">
                  <td style="${tdStyle}">${safeRender(item.owner.name)}</td>
                  <td style="${tdStyle}">${safeRender(item.owner.building)}</td>
                  <td style="${tdStyle}">${safeRender(item.owner.letter)}</td>
                  <td style="${tdStyle}">${safeRender(item.owner.apartment)}</td>
                  <td style="${tdStyle}">${safeRender(item.owner.carMake)} ${safeRender(item.owner.carModel)}</td>
                  <td style="${tdStyle} text-align: right;">${formatNumber(item.pendingAmountUSD)}</td>
                  <td style="${tdStyle}">${safeRender(item.pendingMonths)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } else if (title.includes('Pagos de Comercios')) { // NEW: Commercial Payments Report HTML
        tableHtml = `
          <h3 style="font-size: 1.25rem; font-weight: bold; text-align: center; margin-bottom: 1rem; padding: 0.5rem; background-color: ${titleBgColor}; color: #1f2937; border-radius: 0.375rem;">${title}</h3>
          <table style="${tableStyle}">
            <thead>
              <tr style="background-color: #059669; color: white;">
                <th style="${thStyle}">Comercio</th><th style="${thStyle}">Fecha</th><th style="${thStyle}">Concepto</th><th style="${thStyle} text-align: right;">Monto USD</th><th style="${thStyle} text-align: right;">Monto Bs.</th><th style="${thStyle}">Modalidad</th>
              </tr>
            </thead>
            <tbody>
              ${dataToUse.length === 0 ? `
                <tr>
                  <td colSpan="6" style="${tdStyle} color: #6b7280;">No hay pagos de comercios para este mes.</td>
                </tr>
              ` : dataToUse.map((payment, index) => {
                const conceptDisplay = payment.concept === 'Aporte Mensual' && payment.monthsPaid && payment.monthsPaid.length > 0
                  ? `${safeRender(payment.concept)} (${safeRender(payment.monthsPaid)})`
                  : safeRender(payment.concept);

                let totalUSD = 0;
                let totalBs = 0;

                (payment.paymentDetails || []).forEach(detail => { // Safely access paymentDetails
                  if (detail.currency === 'USD') {
                    totalUSD += parseFloat(detail.amount) || 0;
                  }
                  if (detail.currency === 'Bolívares') {
                    totalBs += parseFloat(detail.amount) || 0;
                  }
                });

                return `
                  <tr style="${index % 2 === 0 ? trEvenStyle : trOddStyle}">
                    <td style="${tdStyle}">${safeRender(payment.name)}</td>
                    <td style="${tdStyle}">${formatDate(payment.date)}</td>
                    <td style="${tdStyle} font-size: 9px;">${conceptDisplay}</td>
                    <td style="${tdStyle} text-align: right;">${formatNumber(totalUSD)}</td>
                    <td style="${tdStyle} text-align: right;">${formatNumber(totalBs)}</td>
                    <td style="${tdStyle}">${safeRender(payment.paymentDetails[0]?.method || 'N/A')}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
            <tfoot>
              <tr style="${tfootStyle}">
                <td colSpan="3" style="${tdStyle} text-align: right; font-weight: bold;">Total del Mes:</td>
                <td style="${tdStyle} text-align: right; font-weight: bold;">
                  ${formatNumber(dataToUse.reduce((sum, p) => sum + (p.paymentDetails || []).reduce((s, d) => s + (d.currency === 'USD' ? (parseFloat(d.amount) || 0) : 0), 0), 0))}
                </td>
                <td style="${tdStyle} text-align: right; font-weight: bold;">
                  ${formatNumber(dataToUse.reduce((sum, p) => sum + (p.paymentDetails || []).reduce((s, d) => s + (d.currency === 'Bolívares' ? (parseFloat(d.amount) || 0) : 0), 0), 0))}
                </td>
                <td colSpan="1" style="${tdStyle}"></td>
              </tr>
            </tfoot>
          </table>
        `;
      } else if (title.includes('Gastos Mensual')) { // Expenses Report HTML
        tableHtml = `
          <h3 style="font-size: 1.25rem; font-weight: bold; text-align: center; margin-bottom: 1rem; padding: 0.5rem; background-color: ${titleBgColor}; color: #1f2937; border-radius: 0.375rem;">${title}</h3>
          <table style="${tableStyle}">
            <thead>
              <tr style="background-color: #059669; color: white;">
                <th style="${thStyle}">Fecha</th><th style="${thStyle}">Concepto</th><th style="${thStyle}">Beneficiario</th><th style="${thStyle} text-align: right;">Monto USD</th><th style="${thStyle} text-align: right;">Monto Bs.</th><th style="${thStyle}">Modalidad</th>
              </tr>
            </thead>
            <tbody>
              ${dataToUse.length === 0 ? `
                <tr>
                  <td colSpan="6" style="${tdStyle} color: #6b7280;">No hay gastos para este mes.</td>
                </tr>
              ` : dataToUse.map((expense, index) => `
                <tr style="${index % 2 === 0 ? trEvenStyle : trOddStyle}">
                  <td style="${tdStyle}">${formatDate(expense.date)}</td>
                  <td style="${tdStyle}">${safeRender(expense.concept)}</td>
                  <td style="${tdStyle}">${safeRender(expense.beneficiary)}</td>
                  <td style="${tdStyle} text-align: right;">
                    ${expense.currency === 'USD' ? formatNumber(expense.amount) : '-'}
                  </td>
                  <td style="${tdStyle} text-align: right;">
                    ${expense.currency === 'Bolívares' ? formatNumber(expense.totalToDebit) : '-'}
                  </td>
                  <td style="${tdStyle}">${safeRender(expense.method)}</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr style="${tfootStyle}">
                <td colSpan="3" style="${tdStyle} text-align: right; font-weight: bold;">Total del Mes:</td>
                <td style="${tdStyle} text-align: right; font-weight: bold;">
                  ${formatNumber(dataToUse.reduce((sum, e) => sum + (e.currency === 'USD' ? (parseFloat(e.amount) || 0) : 0), 0))}
                </td>
                <td style="${tdStyle} text-align: right; font-weight: bold;">
                  ${formatNumber(dataToUse.reduce((sum, e) => sum + (e.currency === 'Bolívares' ? (parseFloat(e.totalToDebit) || 0) : 0), 0))}
                </td>
                <td colSpan="1" style="${tdStyle}"></td>
              </tr>
            </tfoot>
          </table>
        `;
      }
      tempDiv.innerHTML = tableHtml;
    }

    try {
      const input = tempDiv || elementRef.current; // Use tempDiv if it exists, otherwise the ref
      const canvas = await window.html2canvas(input, { scale: 2, useCORS: true }); // Increased scale for better quality

      const imgData = canvas.toDataURL('image/png');
      const pdf = new window.jspdf.jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' for A4 size

      const imgWidth = 210; // A4 width in mm
      const pageHeight = 297; // A4 height in mm
      const imgHeight = canvas.height * imgWidth / canvas.width; // Calculate image height based on A4 width and aspect ratio

      // If the image fits on one page, add it directly
      if (imgHeight <= pageHeight) {
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
      } else {
        // If it's too tall, scale down to fit on one page
        const scaleFactor = pageHeight / imgHeight;
        const scaledImgWidth = imgWidth * scaleFactor;
        const scaledImgHeight = imgHeight * scaleFactor;
        pdf.addImage(imgData, 'PNG', (imgWidth - scaledImgWidth) / 2, 0, scaledImgWidth, scaledImgHeight); // Center horizontally
      }

      pdf.save(filename);
    } catch (error) {
      console.error("Error generating PDF:", error);
      setErrorMessage("Error al generar el PDF. Asegúrese de que el contenido sea visible y las librerías cargadas.");
    } finally {
      if (tempDiv) {
        document.body.removeChild(tempDiv); // Clean up the temporary div
      }
    }
  };

  // --- Monthly Summary Calculation ---
  const getMonthlySummary = useCallback((month, year) => { // Added month and year as arguments
    let totalIncomeUSD = 0;
    let totalIncomeVES = 0;
    let totalExpensesUSD = 0;
    let totalExpensesVES = 0;
    let totalCurrencyPurchasesUSD = 0; // New variable for currency purchases in USD

    payments.forEach(p => {
      // Sum amounts from paymentDetails for income based on their individual currency
      (p.paymentDetails || []).forEach(detail => { // Safely access paymentDetails
        if (detail.currency === 'USD') {
          totalIncomeUSD += detail.amount;
        } else if (detail.currency === 'Bolívares') {
          totalIncomeVES += detail.amount;
        }
      });
    });

    // NEW: Include commercial payments in income calculation
    commercialPayments.forEach(cp => {
      const commercialPaymentDate = new Date(cp.date);
      if (commercialPaymentDate.getMonth() + 1 === month && commercialPaymentDate.getFullYear() === year) {
        (cp.paymentDetails || []).forEach(detail => { // Safely access paymentDetails
          if (detail.currency === 'USD') {
            totalIncomeUSD += detail.amount;
          } else if (detail.currency === 'Bolívares') {
            totalIncomeVES += detail.amount;
          }
        });
      }
    });

    expenses.forEach(e => {
      const expenseDate = new Date(e.date);
      if (expenseDate.getMonth() + 1 === month && expenseDate.getFullYear() === year) { // Use arguments
        if (e.currency === 'USD') {
          totalExpensesUSD += e.amount;
        } else {
          totalExpensesVES += e.totalToDebit; // Use totalToDebit for expenses in Bs
        }
      }
    });

    // Calculate currency purchases for the month and year
    currencyPurchases.forEach(cp => {
      const purchaseDate = new Date(cp.date);
      if (purchaseDate.getMonth() + 1 === month && purchaseDate.getFullYear() === year) {
        totalCurrencyPurchasesUSD += cp.amount; // Amount of USD purchased
        // totalExpensesVES += cp.totalToDebit; // REMOVED: This was causing double counting. The associated expense already adds this to totalExpensesVES.
      }
    });


    const realAvailabilityUSD = totalIncomeUSD + totalCurrencyPurchasesUSD - totalExpensesUSD; // Add purchased USD to availability
    const realAvailabilityVES = totalIncomeVES - totalExpensesVES;

    return { totalIncomeUSD, totalIncomeVES, totalExpensesUSD, totalExpensesVES, realAvailabilityUSD, realAvailabilityVES, totalCurrencyPurchasesUSD };
  }, [payments, expenses, currencyPurchases, commercialPayments]); // Dependencies for useCallback

  const monthlySummary = getMonthlySummary(reportMonth, reportYear); // Pass arguments to the function

  // --- Filtered Reports ---
  const filteredPayments = payments.filter(p => {
    const paymentDate = new Date(p.date);
    return paymentDate.getMonth() + 1 === reportMonth && paymentDate.getFullYear() === reportYear;
  });

  const filteredExpenses = expenses.filter(e => {
    const expenseDate = new Date(e.date);
    return expenseDate.getMonth() + 1 === reportMonth && expenseDate.getFullYear() === reportYear; // Use reportYear here
  });

  const filteredCurrencyPurchases = currencyPurchases.filter(cp => {
    const purchaseDate = new Date(cp.date);
    return purchaseDate.getMonth() + 1 === reportMonth && purchaseDate.getFullYear() === reportYear;
  });

  // NEW: Filtered Commercial Payments for reports
  const filteredCommercialPayments = commercialPayments.filter(cp => {
    const commercialPaymentDate = new Date(cp.date);
    return commercialPaymentDate.getMonth() + 1 === reportMonth && commercialPaymentDate.getFullYear() === reportYear;
  });

  // --- Calculate Pending Months for Report ---
  const calculatePendingMonths = useCallback((year) => { // Added year as argument
    const selectedReportYear = year; // Use argument
    const today = new Date();
    const currentMonthIndex = today.getMonth(); // 0-indexed
    const currentYearInt = today.getFullYear();

    const allExpectedMonths = [];
    for (let y = selectedReportYear; y <= currentYearInt; y++) { // Iterate from reportYear up to currentYear
      const startMonth = 0; // Always start from January for the expected months
      // If it's the current year, go up to the *previous* month. Otherwise, go to Dec.
      const endMonth = (y === currentYearInt) ? (currentMonthIndex - 1) : 11;

      for (let m = startMonth; m <= endMonth; m++) {
        // Only add if the month is valid (i.e., not a negative month index if currentMonthIndex was 0)
        if (m >= 0) {
          allExpectedMonths.push(`${monthsOfYear[m]}-${y}`);
        }
      }
    }

    const pendingData = owners.map(owner => {
      const ownerPayments = payments.filter(p => p.concept === 'Pago de Mensualidad' && p.ownerId === owner.id);
      const paidMonths = new Set();
      ownerPayments.forEach(p => {
        if (Array.isArray(p.monthsPaid)) {
          p.monthsPaid.forEach(monthYear => paidMonths.add(monthYear));
        }
      });

      const pendingMonths = allExpectedMonths.filter(monthYear => {
        return !paidMonths.has(monthYear); // If it's in allExpectedMonths and not paid, it's pending
      });

      const pendingAmountUSD = pendingMonths.length * 4; // 4 USD per pending month

      return {
        owner: {
          name: owner.name,
          building: owner.building,
          letter: owner.letter,
          apartment: owner.apartment,
          carMake: owner.carMake,
          carModel: owner.carModel,
        },
        pendingMonths: pendingMonths.sort((a, b) => { // Sort pending months for consistent display
          const [monthA, yearA] = a.split('-');
          const [monthB, yearB] = b.split('-');
          const monthIndexA = monthsOfYear.indexOf(monthA);
          const monthIndexB = monthsOfYear.indexOf(monthB);
          if (parseInt(yearA) !== parseInt(yearB)) {
            return parseInt(yearA) - parseInt(yearB);
          }
          return monthIndexA - monthIndexB;
        }),
        pendingAmountUSD: pendingAmountUSD
      };
    }).filter(item => item.pendingMonths.length > 0); // Only show owners with pending payments

    setPendingPaymentsReport(pendingData);
  }, [owners, payments]); // Dependencies for useCallback

  // Use useEffect to call this function when dependencies change
  useEffect(() => {
    calculatePendingMonths(reportYear); // Pass reportYear as argument
  }, [calculatePendingMonths, reportYear]); // Dependency on the memoized function and reportYear


  if (loading) {
    return <div className="flex items-center justify-center min-h-screen text-xl font-semibold text-gray-700">Cargando Dashboard...</div>;
  }

  if (error) {
    // Ensure error is a string before rendering directly
    const errorMessageToDisplay = typeof error === 'object' ? JSON.stringify(error) : String(error);
    return <div className="flex items-center justify-center min-h-screen text-xl font-semibold text-red-600">Error: {errorMessageToDisplay}</div>;
  }

  // Filtered and sorted owners for PDF generation
  const getFilteredAndSortedOwners = (filterBuildings = []) => {
    let filteredOwners = owners;
    if (filterBuildings && filterBuildings.length > 0) {
      filteredOwners = owners.filter(owner => filterBuildings.includes(owner.building));
    }

    return filteredOwners.slice().sort((a, b) => {
      // Sort by building
      const buildingA = a.building || '';
      const buildingB = b.building || '';
      if (buildingA < buildingB) return -1;
      if (buildingA > buildingB) return 1;

      // Then by letter
      const letterA = a.letter || '';
      const letterB = b.letter || '';
      if (letterA < letterB) return -1;
      if (letterA > letterB) return 1;

      // Then by apartment (numerical sort)
      const apartmentA = parseInt(a.apartment) || 0;
      const apartmentB = parseInt(b.apartment) || 0;
      return apartmentA - apartmentB;
    });
  };

  // Handler for multi-select filter
  const handleBuildingFilterChange = (e) => {
    const { value, checked } = e.target;
    setSelectedBuildingsFilter(prev => {
      if (checked) {
        return [...prev, value];
      } else {
        return prev.filter(building => building !== value);
      }
    });
  };


  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-100 font-inter text-gray-900 p-4 sm:p-6">
      <header className="bg-gradient-to-r from-blue-700 to-purple-700 shadow-xl rounded-lg p-4 mb-6">
        <h1 className="text-3xl font-extrabold text-center text-white mb-2">Dashboard de Gestión de Estacionamiento</h1>
        <p className="text-center text-purple-100 text-sm">ID de Usuario: <span className="font-mono text-xs bg-purple-800 px-2 py-1 rounded-md opacity-80">{safeRender(userId)}</span></p>
        <nav className="flex flex-wrap justify-center gap-2 sm:gap-4 mt-4">
          <Button onClick={() => setActiveTab('resumen')} className={activeTab === 'resumen' ? 'bg-purple-800 hover:bg-purple-900' : 'bg-blue-600 hover:bg-blue-700'}>
            <Home className="inline-block mr-2" size={18} />Resumen Mensual
          </Button>
          <Button onClick={() => setActiveTab('propietarios')} className={activeTab === 'propietarios' ? 'bg-purple-800 hover:bg-purple-900' : 'bg-blue-600 hover:bg-blue-700'}>
            <Users className="inline-block mr-2" size={18} />Propietarios
          </Button>
          <Button onClick={() => setActiveTab('pagos')} className={activeTab === 'pagos' ? 'bg-purple-800 hover:bg-purple-900' : 'bg-blue-600 hover:bg-blue-700'}>
            <DollarSign className="inline-block mr-2" size={18} />Pagos
          </Button>
          <Button onClick={() => setActiveTab('gastos')} className={activeTab === 'gastos' ? 'bg-purple-800 hover:bg-purple-900' : 'bg-blue-600 hover:bg-blue-700'}>
            <TrendingDown className="inline-block mr-2" size={18} />Gastos
          </Button>
          <Button onClick={() => setActiveTab('compraDivisas')} className={activeTab === 'compraDivisas' ? 'bg-purple-800 hover:bg-purple-900' : 'bg-blue-600 hover:bg-blue-700'}>
            <CreditCard className="inline-block mr-2" size={18} />Compra de Divisas
          </Button>
          {/* NEW: Comercio Tab */}
          <Button onClick={() => setActiveTab('comercio')} className={activeTab === 'comercio' ? 'bg-purple-800 hover:bg-purple-900' : 'bg-blue-600 hover:bg-blue-700'}>
            <ShoppingBag className="inline-block mr-2" size={18} />Comercio
          </Button>
          <Button onClick={() => setActiveTab('reportes')} className={activeTab === 'reportes' ? 'bg-purple-800 hover:bg-purple-900' : 'bg-blue-600 hover:bg-blue-700'}>
            <FileText className="inline-block mr-2" size={18} />Reportes
          </Button>
        </nav>
      </header>

      <main className="bg-white shadow-xl rounded-lg p-4 sm:p-6">
        {successMessage && (
          <div className="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong className="font-bold">Éxito!</strong>
            <span className="block sm:inline"> {safeRender(successMessage)}</span>
          </div>
        )}
        {errorMessage && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong className="font-bold">Error!</strong>
            <span className="block sm:inline"> {safeRender(errorMessage)}</span>
          </div>
        )}

        {activeTab === 'resumen' && (
          <section>
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Resumen Mensual</h2>
            <div className="flex flex-col sm:flex-row gap-4 mb-6">
              <InputField
                label="Mes"
                type="select"
                value={reportMonth}
                onChange={(e) => setReportMonth(parseInt(e.target.value))}
                options={Array.from({ length: 12 }, (_, i) => ({ value: i + 1, label: new Date(0, i).toLocaleString('es-ES', { month: 'long' }) }))}
              />
              <InputField
                label="Año"
                type="select"
                value={reportYear}
                onChange={(e) => setReportYear(parseInt(e.target.value))}
                options={Array.from({ length: 5 }, (_, i) => ({ value: new Date().getFullYear() - 2 + i, label: new Date().getFullYear() - 2 + i }))}
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <div className="bg-emerald-50 p-6 rounded-lg shadow-md border border-emerald-200">
                <h3 className="text-xl font-semibold text-emerald-800 mb-3">Ingresos Totales</h3>
                <p className="text-3xl font-bold text-emerald-900 mb-2">USD {formatNumber(monthlySummary.totalIncomeUSD)}</p>
                <p className="text-xl font-semibold text-emerald-800">Bs. {formatNumber(monthlySummary.totalIncomeVES)}</p>
              </div>
              <div className="bg-rose-50 p-6 rounded-lg shadow-md border border-rose-200">
                <h3 className="text-xl font-semibold text-rose-800 mb-3">Gastos Totales</h3>
                <p className="text-3xl font-bold text-rose-900 mb-2">USD {formatNumber(monthlySummary.totalExpensesUSD)}</p>
                <p className="text-xl font-semibold text-rose-800">Bs. {formatNumber(monthlySummary.totalExpensesVES)}</p>
              </div>
              {/* New card for Currency Purchases */}
              <div className="bg-blue-50 p-6 rounded-lg shadow-md border border-blue-200">
                <h3 className="text-xl font-semibold text-blue-800 mb-3">Compras de Divisas</h3>
                <p className="text-3xl font-bold text-blue-900 mb-2">USD {formatNumber(monthlySummary.totalCurrencyPurchasesUSD)}</p>
              </div>
              <div className="bg-indigo-50 p-6 rounded-lg shadow-md border border-indigo-200">
                <h3 className="text-xl font-semibold text-indigo-800 mb-3">Disponibilidad Real</h3>
                <p className="text-3xl font-bold text-indigo-900 mb-2">USD {formatNumber(monthlySummary.realAvailabilityUSD)}</p>
                <p className="text-xl font-semibold text-indigo-800">Bs. {formatNumber(monthlySummary.realAvailabilityVES)}</p>
              </div>
            </div>
          </section>
        )}

        {activeTab === 'propietarios' && (
          <section>
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Registro de Propietarios</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
              <InputField label="Nombre y Apellido" name="name" value={newOwner.name} onChange={handleOwnerChange} placeholder="Ej: Juan Pérez" />
              <InputField label="Edificio" name="building" value={newOwner.building} onChange={handleOwnerChange} type="select" options={buildingOptions} placeholder="Seleccione un edificio" />
              <InputField label="Letra" name="letter" value={newOwner.letter} onChange={handleOwnerChange} type="select" options={letterOptions} placeholder="Seleccione una letra" />
              <InputField label="Apartamento" name="apartment" value={newOwner.apartment} onChange={handleOwnerChange} placeholder="Ej: 101" />
              <InputField label="Piso" name="floor" value={newOwner.floor} onChange={handleOwnerChange} type="select" options={floorOptions} placeholder="Seleccione un piso" />
              <InputField
                label="Marca de Vehículo"
                name="carMake"
                value={newOwner.carMake}
                onChange={handleOwnerChange}
                type="select"
                options={Object.keys(carData).sort()}
                placeholder="Seleccione una marca"
              />
              {newOwner.carMake === 'Otro' ? (
                <InputField
                  label="Especificar Marca"
                  name="otherCarMake"
                  value={otherCarMake}
                  onChange={handleOtherCarMakeChange}
                  placeholder="Ej: Tesla"
                />
              ) : (
                <InputField
                  label="Modelo de Vehículo"
                  name="carModel"
                  value={newOwner.carModel}
                  onChange={handleOwnerChange}
                  type="select"
                  options={carData[newOwner.carMake] || []}
                  placeholder="Seleccione un modelo"
                  disabled={!newOwner.carMake}
                />
              )}
              {newOwner.carMake === 'Otro' && (
                <InputField
                  label="Modelo de Vehículo (Manual)"
                  name="carModel"
                  value={newOwner.carModel}
                  onChange={handleOwnerChange}
                  placeholder="Ej: Model 3"
                />
              )}
              <InputField label="Placa" name="licensePlate" value={newOwner.licensePlate} onChange={handleOwnerChange} placeholder="Ej: ABC123" />
              <InputField label="Color" name="color" value={newOwner.color} onChange={handleOwnerChange} type="select" options={colors} placeholder="Seleccione un color" />
              <InputField label="Correo Electrónico" name="email" value={newOwner.email} onChange={handleOwnerChange} placeholder="ejemplo@dominio.com" type="email" />
              <InputField label="Teléfono" name="phone" value={newOwner.phone} onChange={handleOwnerChange} placeholder="Ej: +584123456789" type="tel" />
              <InputField label="Código de Control" name="controlCode" value={newOwner.controlCode} onChange={handleOwnerChange} placeholder="Ej: CC123" />
              <InputField
                label="Condición"
                name="condition"
                value={newOwner.condition}
                onChange={handleOwnerChange}
                type="select"
                options={conditionOptions}
                placeholder="Seleccione una condición"
              />
              <InputField label="Observación" name="observation" value={newOwner.observation} onChange={handleOwnerChange} placeholder="Notas adicionales" className="sm:col-span-2 lg:col-span-3" />
              <div className="sm:col-span-2 lg:col-span-3 flex justify-end gap-2">
                <Button onClick={addOrUpdateOwner}>
                  {editingOwnerId ? 'Guardar Cambios' : 'Registrar Propietario'}
                </Button>
                {editingOwnerId && (
                  <Button onClick={cancelEditOwner} className="bg-gray-500 hover:bg-gray-600">
                    Cancelar Edición
                  </Button>
                )}
              </div>
            </div>

            <h3 className="text-xl font-bold text-gray-800 mb-3">Propietarios Registrados</h3>
            <div className="mb-4 p-4 border border-gray-200 rounded-lg bg-gray-50">
              <InputField
                label="Filtrar por Edificio(s)"
                name="selectedBuildingsFilter"
                type="checkbox-group" // Changed to checkbox-group
                value={selectedBuildingsFilter}
                onChange={handleBuildingFilterChange}
                options={buildingOptions.map(b => ({ value: b, label: b }))}
              />
            </div>
            <div className="flex justify-end gap-2 mb-4">
              <Button onClick={() => downloadCSV(owners, 'propietarios.csv')}>Descargar CSV</Button>
              <Button onClick={() => downloadPDF(ownersPdfContentRef, 'propietarios.pdf', getFilteredAndSortedOwners(selectedBuildingsFilter), 'Reporte de Propietarios')} disabled={!pdfLibsLoaded}>Descargar PDF (Filtrado)</Button>
            </div>
            {/* Visible table in the UI */}
            <div className="overflow-x-auto rounded-lg shadow-md" ref={ownersTableRef}>
              <table className="min-w-full bg-white border border-gray-200">
                <thead className="bg-gray-100">
                  {/* Corrected: No whitespace between <th> tags */}
                  <tr className="bg-gray-100">
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Nombre</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Edificio</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Letra</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Apto/Piso</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Vehículo</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Placa/Color</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Condición</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Email</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Teléfono</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {owners.length === 0 ? (
                    <tr>
                      <td colSpan="10" className="py-4 px-4 text-center text-gray-500">No hay propietarios registrados.</td>
                    </tr>
                  ) : (
                    owners.map(owner => (
                      <tr key={owner.id} className="hover:bg-gray-50">
                        <td className="py-2 px-4 border-b text-sm">{safeRender(owner.name)}</td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(owner.building)}</td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(owner.letter)}</td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(owner.apartment)} / {safeRender(owner.floor)}</td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(owner.carMake)} {safeRender(owner.carModel)}</td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(owner.licensePlate)} ({safeRender(owner.color)})</td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(owner.condition)}</td> {/* Display condition */}
                        <td className="py-2 px-4 border-b text-sm">{safeRender(owner.email)}</td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(owner.phone)}</td>
                        <td className="py-2 px-4 border-b text-sm flex gap-2">
                          <Button onClick={() => handleEditOwner(owner)} className="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 text-xs">Editar</Button>
                          <Button onClick={() => deleteOwner(owner.id)} className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 text-xs">Eliminar</Button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>

            {/* Hidden content for PDF generation only - This will be dynamically generated by downloadPDF */}
            <div ref={ownersPdfContentRef} className="absolute -left-[9999px] w-full p-4 bg-white">
              {/* Content will be injected here by the downloadPDF function */}
            </div>
          </section>
        )}

        {activeTab === 'pagos' && (
          <section>
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Registro de Pagos</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
              <InputField
                label="Propietario"
                name="ownerId"
                value={newPayment.ownerId}
                onChange={handlePaymentChange}
                type="select"
                placeholder="Seleccione un propietario"
              >
                {owners.map(owner => (
                  <option key={owner.id} value={owner.id}>{safeRender(owner.name)} ({safeRender(owner.building)} {safeRender(owner.apartment)})</option>
                ))}
              </InputField>
              <InputField label="Fecha de Pago" name="date" value={newPayment.date} onChange={handlePaymentChange} type="date" />
              <InputField
                label="Concepto"
                name="concept"
                value={newPayment.concept}
                onChange={handlePaymentChange}
                type="select"
                options={paymentConcepts}
                placeholder="Seleccione concepto"
              />
              {newPayment.concept === 'Pago de Mensualidad' && (
                <InputField
                  label="Mes(es) y Año(s) Cancelado(s)"
                  name="monthsPaid"
                  type="checkbox-group"
                  value={newPayment.monthsPaid}
                  onChange={handlePaymentChange}
                  options={monthYearOptions}
                />
              )}
              {/* Removed top-level currency as it's now per-detail */}

              <div className="lg:col-span-3 border-t border-gray-200 pt-4 mt-4">
                <h3 className="text-lg font-bold text-gray-800 mb-3">Detalles de las Transacciones</h3>
                {(newPayment.paymentDetails || []).map((detail, index) => ( // Safely access paymentDetails
                  <div key={index} className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-3 border border-gray-200 rounded-md bg-white relative">
                    {(newPayment.paymentDetails || []).length > 1 && ( // Safely access paymentDetails
                      <button
                        onClick={() => removePaymentDetail(index)}
                        className="absolute top-2 right-2 text-red-500 hover:text-red-700 text-xl font-bold"
                        title="Eliminar esta transacción"
                      >
                        &times;
                      </button>
                    )}
                    <InputField
                      label="Modalidad de Pago"
                      name="method"
                      value={detail.method}
                      onChange={(e) => handlePaymentDetailChange(index, e)}
                      type="select"
                      options={["Efectivo", "Pago Móvil", "Transferencia"]}
                      placeholder="Seleccione modalidad"
                    />
                    <InputField
                      label="Moneda"
                      name="currency"
                      value={detail.currency}
                      onChange={(e) => handlePaymentDetailChange(index, e)}
                      type="select"
                      options={["USD", "Bolívares"]}
                      placeholder="Seleccione moneda"
                    />
                    {(detail.method === 'Pago Móvil' || detail.method === 'Transferencia') && (
                      <>
                        <InputField
                          label="Banco"
                          name="bank"
                          value={detail.bank}
                          onChange={(e) => handlePaymentDetailChange(index, e)}
                          type="select"
                          options={venezuelanBanks}
                          placeholder="Seleccione banco"
                        />
                        <InputField
                          label="Referencia"
                          name="reference"
                          value={detail.reference}
                          onChange={(e) => handlePaymentDetailChange(index, e)}
                          placeholder="Referencia de la transacción"
                        />
                      </>
                    )}
                    <InputField
                      label="Monto"
                      name="amount"
                      value={detail.amount}
                      onChange={(e) => handlePaymentDetailChange(index, e)}
                      type="number"
                      placeholder="Monto de esta transacción"
                    />
                  </div>
                ))}
                <div className="flex justify-center mt-4">
                  <Button onClick={addPaymentDetail} className="bg-green-600 hover:bg-green-700 text-white">
                    Añadir Otra Transacción
                  </Button>
                </div>
              </div>

              <div className="sm:col-span-2 lg:col-span-3 flex justify-end mt-4">
                <Button onClick={addPayment}>Registrar Pago Completo</Button>
              </div>
            </div>

            <h3 className="text-xl font-bold text-gray-800 mb-3">Pagos Registrados</h3>
            <div className="overflow-x-auto rounded-lg shadow-md">
              <table className="min-w-full bg-white border border-gray-200">
                <thead className="bg-gray-100">
                  {/* Corrected: No whitespace between <th> tags */}
                  <tr>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Fecha</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Propietario</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Concepto</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Monto y Modalidad</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {payments.length === 0 ? (
                    <tr>
                      <td colSpan="5" className="py-4 px-4 text-center text-gray-500">No hay pagos registrados.</td>
                    </tr>
                  ) : (
                    payments.map(payment => {
                      const owner = owners.find(o => o.id === payment.ownerId);
                      // Calculate total amounts per currency for display in table
                      const totalAmounts = (payment.paymentDetails || []).reduce((acc, detail) => { // Safely access paymentDetails
                        acc[detail.currency] = (acc[detail.currency] || 0) + (parseFloat(detail.amount) || 0);
                        return acc;
                      }, {});

                      return (
                        <tr key={payment.id} className="hover:bg-gray-50">
                          <td className="py-2 px-4 border-b text-sm">{safeRender(payment.date)}</td>
                          <td className="py-2 px-4 border-b text-sm">{owner ? safeRender(owner.name) : 'Desconocido'}</td>
                          <td className="py-2 px-4 border-b text-sm">
                            {safeRender(payment.concept)}
                            {payment.concept === 'Pago de Mensualidad' && payment.monthsPaid && payment.monthsPaid.length > 0 &&
                              ` (${safeRender(payment.monthsPaid)})`
                            }
                          </td>
                          <td className="py-2 px-4 border-b text-sm">
                            {(payment.paymentDetails || []).map((detail, idx) => ( // Safely access paymentDetails
                              <div key={idx} className="mb-1 last:mb-0">
                                {safeRender(detail.currency)} {formatNumber(detail.amount)} ({safeRender(detail.method)} {detail.bank ? ` - ${safeRender(detail.bank)}` : ''} {detail.reference ? ` - Ref: ${safeRender(detail.reference)}` : ''})
                              </div>
                            ))}
                            {Object.keys(totalAmounts).map(currency => (
                              <div key={currency} className="font-bold mt-2 pt-2 border-t border-gray-200">
                                Total {safeRender(currency)}: {formatNumber(totalAmounts[currency])}
                              </div>
                            ))}
                          </td>
                          <td className="py-2 px-4 border-b text-sm">
                            <Button onClick={() => generatePaymentReceipt(payment)} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 text-xs" disabled={!pdfLibsLoaded}>Recibo</Button>
                          </td>
                        </tr>
                      );
                    })
                  )}
                </tbody>
              </table>
            </div>

            <Modal show={showPaymentReceiptModal} onClose={() => setShowPaymentReceiptModal(false)} title="Recibo de Pago">
              {currentPaymentReceipt && (
                <div ref={paymentReceiptRef} className="p-6 bg-white rounded-lg shadow-2xl border border-blue-200 relative overflow-hidden">
                  {/* Decorative Header */}
                  <div className="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-blue-600 to-blue-800 rounded-t-lg flex items-center justify-center">
                    <h3 className="text-2xl font-extrabold text-white tracking-wide">RECIBO DE PAGO</h3>
                  </div>
                  <div className="pt-20 pb-4"> {/* Adjusted padding to make space for the header */}
                    <p className="text-center text-gray-700 text-sm font-semibold mb-4">Comité de estacionamiento Bloque 22-23</p> {/* Subtitle */}
                    <div className="text-right text-gray-600 text-sm mb-4">
                      <p><strong>Fecha de Emisión:</strong> {safeRender(new Date().toLocaleDateString('es-ES'))}</p>
                      <p><strong>Referencia del Recibo:</strong> {safeRender(currentPaymentReceipt.payment.receiptId || 'N/A')}</p> {/* Display receipt ID */}
                    </div>

                    <div className="mb-6 border-b pb-4 border-gray-200">
                      <h4 className="text-lg font-semibold text-gray-800 mb-2">Detalles del Propietario:</h4>
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 text-gray-700">
                        <p><strong>Nombre:</strong> {safeRender(currentPaymentReceipt.owner?.name || 'N/A')}</p>
                        <p><strong>Edificio:</strong> {safeRender(currentPaymentReceipt.owner?.building || 'N/A')}</p>
                        <p><strong>Letra:</strong> {safeRender(currentPaymentReceipt.owner?.letter || 'N/A')}</p> {/* Added Letra */}
                        <p><strong>Apartamento:</strong> {safeRender(currentPaymentReceipt.owner?.apartment || 'N/A')}</p>
                        <p><strong>Piso:</strong> {safeRender(currentPaymentReceipt.owner?.floor || 'N/A')}</p>
                        <p className="col-span-full"><strong>Correo:</strong> {safeRender(currentPaymentReceipt.owner?.email || 'N/A')}</p>
                        <p className="col-span-full"><strong>Teléfono:</strong> {safeRender(currentPaymentReceipt.owner?.phone || 'N/A')}</p>
                      </div>
                    </div>

                    <div className="mb-6 border-b pb-4 border-gray-200">
                      <h4 className="text-lg font-semibold text-gray-800 mb-2">Concepto del Pago:</h4>
                      <p className="text-gray-700 mb-2"><strong>Concepto:</strong> {safeRender(currentPaymentReceipt.payment.concept)}</p>
                      {currentPaymentReceipt.payment.concept === 'Pago de Mensualidad' && currentPaymentReceipt.payment.monthsPaid && currentPaymentReceipt.payment.monthsPaid.length > 0 && (
                        <p className="text-gray-700"><strong>Mes(es) Cancelado(s):</strong> {safeRender(currentPaymentReceipt.payment.monthsPaid)}</p>
                      )}
                    </div>

                    <div className="mb-6 border-b pb-4 border-gray-200">
                      <h4 className="text-lg font-semibold text-gray-800 mb-2">Detalles de las Transacciones:</h4>
                      {(currentPaymentReceipt.payment.paymentDetails || []).map((detail, idx) => ( // Safely access paymentDetails
                        <div key={idx} className="grid grid-cols-1 sm:grid-cols-2 gap-2 text-gray-700 mb-2 border-b border-gray-100 pb-2 last:border-b-0">
                          <p><strong>Modalidad:</strong> {safeRender(detail.method)}</p>
                          {(detail.method === 'Pago Móvil' || detail.method === 'Transferencia') && (
                            <>
                              <p><strong>Banco:</strong> {safeRender(detail.bank || 'N/A')}</p>
                              <p><strong>Referencia:</strong> {safeRender(detail.reference || 'N/A')}</p>
                            </>
                          )}
                          <p><strong>Monto:</strong> {safeRender(detail.currency)} {formatNumber(detail.amount)}</p>
                        </div>
                      ))}
                    </div>

                    <div className="text-center mt-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
                      <p className="text-xl font-bold text-blue-800">Monto Total:</p>
                      {/* Calculate and display total per currency */}
                      {Object.keys((currentPaymentReceipt.payment.paymentDetails || []).reduce((acc, detail) => { // Safely access paymentDetails
                        acc[detail.currency] = (acc[detail.currency] || 0) + (parseFloat(detail.amount) || 0);
                        return acc;
                      }, {})).map(currency => (
                        <p key={currency} className="text-4xl font-extrabold text-blue-900 mt-2">
                          {safeRender(currency)} {formatNumber((currentPaymentReceipt.payment.paymentDetails || []).reduce((sum, detail) => { // Safely access paymentDetails
                            return detail.currency === currency ? sum + (parseFloat(detail.amount) || 0) : sum;
                          }, 0))}
                        </p>
                      ))}
                    </div>
                  </div>

                  {/* Decorative Footer */}
                  <div className="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-r from-blue-800 to-blue-600 rounded-b-lg flex items-center justify-center">
                    <p className="text-white text-sm font-semibold">¡Gracias por su pago!</p>
                  </div>
                  <p className="text-center text-gray-600 text-xs mt-4">Este recibo se ha generado como comprobante de pago.</p> {/* New footer text */}
                </div>
              )}
              <div className="flex justify-center mt-4">
                <Button onClick={() => downloadPDF(paymentReceiptRef, `recibo_pago_${currentPaymentReceipt.payment.id}.pdf`)} disabled={!pdfLibsLoaded}>Descargar PDF</Button>
              </div>
            </Modal>
          </section>
        )}

        {activeTab === 'gastos' && (
          <section>
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Registro de Gastos</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
              <InputField label="Fecha del Gasto" name="date" value={newExpense.date} onChange={handleExpenseChange} type="date" />
              <InputField label="Concepto del Gasto" name="concept" value={newExpense.concept} onChange={handleExpenseChange} placeholder="Ej: Mantenimiento, Servicios" />
              <InputField label="Beneficiario" name="beneficiary" value={newExpense.beneficiary} onChange={handleExpenseChange} placeholder="Ej: Electricidad, Plomero" />
              <InputField label="Monto" name="amount" value={newExpense.amount} onChange={handleExpenseChange} type="number" placeholder="Monto del gasto" />
              <InputField
                label="Moneda"
                name="currency"
                value={newExpense.currency}
                onChange={handleExpenseChange}
                type="select"
                options={["USD", "Bolívares"]}
              />
              <InputField
                label="Modalidad de Pago"
                name="method"
                value={newExpense.method}
                onChange={handleExpenseChange}
                type="select"
                options={["Efectivo", "Pago Móvil", "Transferencia", "Débito en cuenta"]} // Added "Débito en cuenta"
                placeholder="Seleccione modalidad"
              />
              {newExpense.method === 'Pago Móvil' && (
                <>
                  <InputField
                    label="% Comisión Pago Móvil"
                    name="commissionPercentage"
                    value={newExpense.commissionPercentage}
                    onChange={handleExpenseChange}
                    type="number"
                    placeholder="Ej: 1.5 (sin %)"
                  />
                  <InputField
                    label="Comisión Pago Móvil (Bs)"
                    name="commissionAmount"
                    value={formatNumber(newExpense.commissionAmount)}
                    type="text"
                    disabled
                  />
                </>
              )}
              <InputField
                label="Total a Debitar"
                name="totalToDebit"
                value={formatNumber(newExpense.totalToDebit)}
                type="text"
                disabled
                className="sm:col-span-2"
              />
              <div className="sm:col-span-2 flex justify-end gap-2">
                <Button onClick={addOrUpdateExpense}>
                  {editingExpenseId ? 'Guardar Cambios' : 'Registrar Gasto'}
                </Button>
                {editingExpenseId && (
                  <Button onClick={cancelEditExpense} className="bg-gray-500 hover:bg-gray-600">
                    Cancelar Edición
                  </Button>
                )}
              </div>
            </div>

            <h3 className="text-xl font-bold text-gray-800 mb-3">Gastos Registrados</h3>
            <div className="overflow-x-auto rounded-lg shadow-md">
              <table className="min-w-full bg-white border border-gray-200">
                <thead className="bg-gray-100">
                  {/* Corrected: No whitespace between <th> tags */}
                  <tr>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Fecha</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Concepto</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Beneficiario</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Monto</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Modalidad</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {expenses.length === 0 ? (
                    <tr>
                      <td colSpan="6" className="py-4 px-4 text-center text-gray-500">No hay gastos registrados.</td>
                    </tr>
                  ) : (
                    expenses.map(expense => {
                      return (
                      <tr key={expense.id} className="hover:bg-gray-50">
                        <td className="py-2 px-4 border-b text-sm">{formatDate(expense.date)}</td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(expense.concept)}</td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(expense.beneficiary)}</td>
                        <td className="py-2 px-4 border-b text-sm">
                          {safeRender(expense.currency)}{' '}
                          {formatNumber(expense.amount)}
                          {expense.method === 'Pago Móvil' && expense.commissionAmount > 0 &&
                            <span className="block text-xs text-gray-500">(+ Comisión: {formatNumber(expense.commissionAmount)})</span>
                          }
                          {expense.method === 'Pago Móvil' && expense.totalToDebit > 0 &&
                            <span className="block text-xs font-semibold">Total: {formatNumber(expense.totalToDebit)}</span>
                          }
                        </td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(expense.method)}</td>
                        <td className="py-2 px-4 border-b text-sm flex gap-2">
                          <Button onClick={() => handleEditExpense(expense)} className="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 text-xs">Editar</Button>
                          <Button onClick={() => deleteExpense(expense.id)} className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 text-xs">Eliminar</Button>
                          <Button onClick={() => generateExpenseReceipt(expense)} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 text-xs" disabled={!pdfLibsLoaded}>Recibo</Button>
                        </td>
                      </tr>
                    );})
                  )}
                </tbody>
              </table>
            </div>

            <Modal show={showExpenseReceiptModal} onClose={() => setShowExpenseReceiptModal(false)} title="Recibo de Gasto">
              {currentExpenseReceipt && (
                <div ref={expenseReceiptRef} className="p-6 bg-white rounded-lg shadow-inner border border-gray-200">
                  <h3 className="text-xl font-bold text-center mb-4 text-gray-800">RECIBO DE GASTO</h3>
                  <div className="text-right text-gray-600 text-sm mb-4">
                      <p><strong>Fecha de Emisión:</strong> {safeRender(new Date().toLocaleDateString('es-ES'))}</p>
                      <p><strong>Referencia del Recibo:</strong> {safeRender(currentExpenseReceipt.receiptId || 'N/A')}</p> {/* Display receipt ID */}
                  </div>
                  <div className="space-y-2 text-gray-700 mb-6 border-b pb-4 border-gray-200">
                    <p><strong>Fecha:</strong> {formatDate(currentExpenseReceipt.date)}</p>
                    <p><strong>Concepto:</strong> {safeRender(currentExpenseReceipt.concept)}</p>
                    <p><strong>Beneficiario:</strong> {safeRender(currentExpenseReceipt.beneficiary)}</p>
                    <p><strong>Monto:</strong> {safeRender(currentExpenseReceipt.currency)} {formatNumber(currentExpenseReceipt.amount)}</p>
                    {currentExpenseReceipt.method === 'Pago Móvil' && currentExpenseReceipt.commissionAmount > 0 && (
                      <p><strong>Comisión Pago Móvil ({safeRender(currentExpenseReceipt.commissionPercentage)}%):</strong> {formatNumber(currentExpenseReceipt.commissionAmount)}</p>
                    )}
                    <p><strong>Modalidad:</strong> {safeRender(currentExpenseReceipt.method)}</p>
                    {currentExpenseReceipt.method === 'Pago Móvil' && currentExpenseReceipt.totalToDebit > 0 && (
                      <p className="font-bold text-lg">Total a Debitar: {formatNumber(currentExpenseReceipt.totalToDebit)}</p>
                    )}
                  </div>
                  <div className="flex justify-between items-end mt-8">
                    <div className="flex flex-col items-center">
                      <p className="text-gray-700 font-semibold">Recibido por:</p>
                      <div className="w-48 h-px bg-gray-400 mt-2"></div> {/* Signature line */}
                    </div>
                    <div className="flex flex-col items-center">
                      <p className="text-gray-700 font-semibold">Responsable: MJLM</p>
                    </div>
                  </div>
                  <div className="mt-6 text-center text-gray-600 text-sm">
                    <p>Este es un comprobante de gasto.</p>
                  </div>
                </div>
              )}
              <div className="flex justify-center mt-4">
                <Button onClick={() => downloadPDF(expenseReceiptRef, `recibo_gasto_${currentExpenseReceipt.id}.pdf`)} disabled={!pdfLibsLoaded}>Descargar PDF</Button>
              </div>
            </Modal>
          </section>
        )}

        {activeTab === 'compraDivisas' && (
          <section>
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Registro de Compra de Divisas</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
              <InputField label="Fecha de la Compra" name="date" value={newCurrencyPurchase.date} onChange={handleCurrencyPurchaseChange} type="date" />
              <InputField
                label="Mecanismo"
                name="mechanism"
                value={newCurrencyPurchase.mechanism}
                onChange={handleCurrencyPurchaseChange}
                type="select"
                options={currencyMechanisms}
                placeholder="Seleccione mecanismo"
              />
              <InputField label="Monto de Divisas a Comprar" name="amount" value={newCurrencyPurchase.amount} onChange={handleCurrencyPurchaseChange} type="number" placeholder="Ej: 1000" />
              <InputField label="Tipo de Cambio" name="exchangeRate" value={newCurrencyPurchase.exchangeRate} onChange={handleCurrencyPurchaseChange} type="number" placeholder="Ej: 36.5" />
              <InputField label="Contravalor en Bs" name="countervalueBs" value={formatNumber(newCurrencyPurchase.countervalueBs)} type="text" disabled />
              <InputField label="% Comisión" name="commissionPercentage" value={newCurrencyPurchase.commissionPercentage} onChange={handleCurrencyPurchaseChange} type="number" placeholder="Ej: 0.5 (sin %)" />
              <InputField label="Comisión en Bs" name="commissionBs" value={formatNumber(newCurrencyPurchase.commissionBs)} type="text" disabled />
              <InputField label="Comisión de Retiro (Bs)" name="withdrawalCommission" value={newCurrencyPurchase.withdrawalCommission} onChange={handleCurrencyPurchaseChange} type="number" placeholder="Ej: 50" />
              <InputField label="Total a Debitar (Bs)" name="totalToDebit" value={formatNumber(newCurrencyPurchase.totalToDebit)} type="text" disabled className="sm:col-span-2" />
              <div className="sm:col-span-2 lg:col-span-3 flex justify-end mt-4">
                <Button onClick={addCurrencyPurchase}>Registrar Compra de Divisas</Button>
              </div>
            </div>

            <h3 className="text-xl font-bold text-gray-800 mb-3">Compras de Divisas Registradas</h3>
            <div className="overflow-x-auto rounded-lg shadow-md">
              <table className="min-w-full bg-white border border-gray-200">
                <thead className="bg-gray-100">
                  {/* Corrected: No whitespace between <th> tags */}
                  <tr>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Fecha</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Mecanismo</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Monto Divisas</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Tasa</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Contravalor Bs</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Comisión Bs</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Retiro Bs</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Total a Debitar Bs</th>
                  </tr>
                </thead>
                <tbody>
                  {currencyPurchases.length === 0 ? (
                    <tr>
                      <td colSpan="8" className="py-4 px-4 text-center text-gray-500">No hay compras de divisas registradas.</td>
                    </tr>
                  ) : (
                    currencyPurchases.map(purchase => (
                      <tr key={purchase.id} className="hover:bg-gray-50">
                        <td className="py-2 px-4 border-b text-sm">{formatDate(purchase.date)}</td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(purchase.mechanism)}</td>
                        <td className="py-2 px-4 border-b text-sm">USD {formatNumber(purchase.amount)}</td>
                        <td className="py-2 px-4 border-b text-sm">{formatNumber(purchase.exchangeRate)}</td>
                        <td className="py-2 px-4 border-b text-sm">Bs. {formatNumber(purchase.countervalueBs)}</td>
                        <td className="py-2 px-4 border-b text-sm">Bs. {formatNumber(purchase.commissionPercentage)}% ({formatNumber(purchase.commissionBs)})</td>
                        <td className="py-2 px-4 border-b text-sm">Bs. {formatNumber(purchase.withdrawalCommission)}</td>
                        <td className="py-2 px-4 border-b text-sm">Bs. {formatNumber(purchase.totalToDebit)}</td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>
          </section>
        )}

        {/* NEW: Comercio Tab Content */}
        {activeTab === 'comercio' && (
          <section>
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Registro de Pagos de Comercios</h2>
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50">
              <InputField label="Nombre del Kiosko o Comercio" name="name" value={newCommercialPayment.name} onChange={handleCommercialPaymentChange} placeholder="Ej: Kiosko La Esquina" />
              <InputField label="Fecha de Cancelación" name="date" value={newCommercialPayment.date} onChange={handleCommercialPaymentChange} type="date" />
              <InputField
                label="Concepto"
                name="concept"
                value={newCommercialPayment.concept}
                onChange={handleCommercialPaymentChange}
                type="select"
                options={commercialPaymentConcepts}
                placeholder="Seleccione concepto"
              />
              {newCommercialPayment.concept === 'Aporte Mensual' && (
                <InputField
                  label="Mes(es) y Año(s) Cancelado(s)"
                  name="monthsPaid"
                  type="checkbox-group"
                  value={newCommercialPayment.monthsPaid}
                  onChange={handleCommercialPaymentChange}
                  options={monthYearOptions}
                />
              )}

              <div className="lg:col-span-3 border-t border-gray-200 pt-4 mt-4">
                <h3 className="text-lg font-bold text-gray-800 mb-3">Detalles de las Transacciones</h3>
                {(newCommercialPayment.paymentDetails || []).map((detail, index) => ( // Safely access paymentDetails
                  <div key={index} className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 p-3 border border-gray-200 rounded-md bg-white relative">
                    {(newCommercialPayment.paymentDetails || []).length > 1 && ( // Safely access paymentDetails
                      <button
                        onClick={() => removeCommercialPaymentDetail(index)}
                        className="absolute top-2 right-2 text-red-500 hover:text-red-700 text-xl font-bold"
                        title="Eliminar esta transacción"
                      >
                        &times;
                      </button>
                    )}
                    <InputField
                      label="Modalidad de Pago"
                      name="method"
                      value={detail.method}
                      onChange={(e) => handleCommercialPaymentDetailChange(index, e)}
                      type="select"
                      options={["Efectivo", "Pago Móvil", "Transferencia"]}
                      placeholder="Seleccione modalidad"
                    />
                    <InputField
                      label="Moneda"
                      name="currency"
                      value={detail.currency}
                      onChange={(e) => handleCommercialPaymentDetailChange(index, e)}
                      type="select"
                      options={["USD", "Bolívares"]}
                      placeholder="Seleccione moneda"
                    />
                    {(detail.method === 'Pago Móvil' || detail.method === 'Transferencia') && (
                      <>
                        <InputField
                          label="Banco"
                          name="bank"
                          value={detail.bank}
                          onChange={(e) => handleCommercialPaymentDetailChange(index, e)}
                          type="select"
                          options={venezuelanBanks}
                          placeholder="Seleccione banco"
                        />
                        <InputField
                          label="Referencia"
                          name="reference"
                          value={detail.reference}
                          onChange={(e) => handleCommercialPaymentDetailChange(index, e)}
                          placeholder="Referencia de la transacción"
                        />
                      </>
                    )}
                    <InputField
                      label="Monto"
                      name="amount"
                      value={detail.amount}
                      onChange={(e) => handleCommercialPaymentDetailChange(index, e)}
                      type="number"
                      placeholder="Monto de esta transacción"
                    />
                  </div>
                ))}
                <div className="flex justify-center mt-4">
                  <Button onClick={addCommercialPaymentDetail} className="bg-green-600 hover:bg-green-700 text-white">
                    Añadir Otra Transacción
                  </Button>
                </div>
              </div>

              <div className="sm:col-span-2 lg:col-span-3 flex justify-end mt-4">
                <Button onClick={addCommercialPayment}>Registrar Pago de Comercio</Button>
              </div>
            </div>

            <h3 className="text-xl font-bold text-gray-800 mb-3">Pagos de Comercios Registrados</h3>
            <div className="overflow-x-auto rounded-lg shadow-md">
              <table className="min-w-full bg-white border border-gray-200">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Comercio</th>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Fecha</th>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Concepto</th>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Monto y Modalidad</th>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {commercialPayments.length === 0 ? (
                    <tr>
                      <td colSpan="5" className="py-4 px-4 text-center text-gray-500">No hay pagos de comercios registrados.</td>
                    </tr>
                  ) : (
                    commercialPayments.map(payment => {
                      const totalAmounts = (payment.paymentDetails || []).reduce((acc, detail) => { // Safely access paymentDetails
                        acc[detail.currency] = (acc[detail.currency] || 0) + (parseFloat(detail.amount) || 0);
                        return acc;
                      }, {});

                      return (
                        <tr key={payment.id} className="hover:bg-gray-50">
                          <td className="py-2 px-4 border-b text-sm">{safeRender(payment.name)}</td>
                          <td className="py-2 px-4 border-b text-sm">{safeRender(payment.date)}</td>
                          <td className="py-2 px-4 border-b text-sm">
                            {safeRender(payment.concept)}
                            {payment.concept === 'Aporte Mensual' && payment.monthsPaid && payment.monthsPaid.length > 0 &&
                              ` (${safeRender(payment.monthsPaid)})`
                            }
                          </td>
                          <td className="py-2 px-4 border-b text-sm">
                            {(payment.paymentDetails || []).map((detail, idx) => ( // Safely access paymentDetails
                              <div key={idx} className="mb-1 last:mb-0">
                                {safeRender(detail.currency)} {formatNumber(detail.amount)} ({safeRender(detail.method)} {detail.bank ? ` - ${safeRender(detail.bank)}` : ''} {detail.reference ? ` - Ref: ${safeRender(detail.reference)}` : ''})
                              </div>
                            ))}
                            {Object.keys(totalAmounts).map(currency => (
                              <div key={currency} className="font-bold mt-2 pt-2 border-t border-gray-200">
                                Total {safeRender(currency)}: {formatNumber(totalAmounts[currency])}
                              </div>
                            ))}
                          </td>
                          <td className="py-2 px-4 border-b text-sm">
                            <Button onClick={() => generateCommercialPaymentReceipt(payment)} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 text-xs" disabled={!pdfLibsLoaded}>Recibo</Button>
                          </td>
                        </tr>
                      );
                    })
                  )}
                </tbody>
              </table>
            </div>

            <Modal show={showCommercialPaymentReceiptModal} onClose={() => setShowCommercialPaymentReceiptModal(false)} title="Recibo de Pago de Comercio">
              {currentCommercialPaymentReceipt && (
                <div ref={commercialPaymentReceiptRef} className="p-6 bg-white rounded-lg shadow-2xl border border-blue-200 relative overflow-hidden">
                  {/* Decorative Header */}
                  <div className="absolute top-0 left-0 w-full h-16 bg-gradient-to-r from-blue-600 to-blue-800 rounded-t-lg flex items-center justify-center">
                    <h3 className="text-2xl font-extrabold text-white tracking-wide">RECIBO DE PAGO DE COMERCIO</h3>
                  </div>
                  <div className="pt-20 pb-4"> {/* Adjusted padding to make space for the header */}
                    <p className="text-center text-gray-700 text-sm font-semibold mb-4">Comité de estacionamiento Bloque 22-23</p> {/* Subtitle */}
                    <div className="text-right text-gray-600 text-sm mb-4">
                      <p><strong>Fecha de Emisión:</strong> {safeRender(new Date().toLocaleDateString('es-ES'))}</p>
                      <p><strong>Referencia del Recibo:</strong> {safeRender(currentCommercialPaymentReceipt.receiptId || 'N/A')}</p>
                    </div>

                    <div className="mb-6 border-b pb-4 border-gray-200">
                      <h4 className="text-lg font-semibold text-gray-800 mb-2">Detalles del Comercio:</h4>
                      <p className="text-gray-700"><strong>Nombre:</strong> {safeRender(currentCommercialPaymentReceipt.name || 'N/A')}</p>
                    </div>

                    <div className="mb-6 border-b pb-4 border-gray-200">
                      <h4 className="text-lg font-semibold text-gray-800 mb-2">Concepto del Pago:</h4>
                      <p className="text-gray-700 mb-2"><strong>Concepto:</strong> {safeRender(currentCommercialPaymentReceipt.concept)}</p>
                      {currentCommercialPaymentReceipt.concept === 'Aporte Mensual' && currentCommercialPaymentReceipt.monthsPaid && currentCommercialPaymentReceipt.monthsPaid.length > 0 && (
                        <p className="text-gray-700"><strong>Mes(es) Cancelado(s):</strong> {safeRender(currentCommercialPaymentReceipt.monthsPaid)}</p>
                      )}
                    </div>

                    <div className="mb-6 border-b pb-4 border-gray-200">
                      <h4 className="text-lg font-semibold text-gray-800 mb-2">Detalles de las Transacciones:</h4>
                      {(currentCommercialPaymentReceipt.paymentDetails || []).map((detail, idx) => ( // Safely access paymentDetails
                        <div key={idx} className="grid grid-cols-1 sm:grid-cols-2 gap-2 text-gray-700 mb-2 border-b border-gray-100 pb-2 last:border-b-0">
                          <p><strong>Modalidad:</strong> {safeRender(detail.method)}</p>
                          {(detail.method === 'Pago Móvil' || detail.method === 'Transferencia') && (
                            <>
                              <p><strong>Banco:</strong> {safeRender(detail.bank || 'N/A')}</p>
                              <p><strong>Referencia:</strong> {safeRender(detail.reference || 'N/A')}</p>
                            </>
                          )}
                          <p><strong>Monto:</strong> {safeRender(detail.currency)} {formatNumber(detail.amount)}</p>
                        </div>
                      ))}
                    </div>

                    <div className="text-center mt-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
                      <p className="text-xl font-bold text-blue-800">Monto Total:</p>
                      {Object.keys((currentCommercialPaymentReceipt.paymentDetails || []).reduce((acc, detail) => { // Safely access paymentDetails
                        acc[detail.currency] = (acc[detail.currency] || 0) + (parseFloat(detail.amount) || 0);
                        return acc;
                      }, {})).map(currency => (
                        <p key={currency} className="text-4xl font-extrabold text-blue-900 mt-2">
                          {safeRender(currency)} {formatNumber((currentCommercialPaymentReceipt.paymentDetails || []).reduce((sum, detail) => { // Safely access paymentDetails
                            return detail.currency === currency ? sum + (parseFloat(detail.amount) || 0) : sum;
                          }, 0))}
                        </p>
                      ))}
                    </div>
                  </div>

                  {/* Decorative Footer */}
                  <div className="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-r from-blue-800 to-blue-600 rounded-b-lg flex items-center justify-center">
                    <p className="text-white text-sm font-semibold">¡Gracias por su pago!</p>
                  </div>
                  <p className="text-center text-gray-600 text-xs mt-4">Este recibo se ha generado como comprobante de pago.</p>
                </div>
              )}
              <div className="flex justify-center mt-4">
                <Button onClick={() => downloadPDF(commercialPaymentReceiptRef, `recibo_comercio_${currentCommercialPaymentReceipt.id}.pdf`)} disabled={!pdfLibsLoaded}>Descargar PDF</Button>
              </div>
            </Modal>
          </section>
        )}

        {activeTab === 'reportes' && (
          <section>
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Reportes Mensuales</h2>
            <div className="flex flex-col sm:flex-row gap-4 mb-6">
              <InputField
                label="Mes del Reporte"
                type="select"
                value={reportMonth}
                onChange={(e) => setReportMonth(parseInt(e.target.value))}
                options={Array.from({ length: 12 }, (_, i) => ({ value: i + 1, label: new Date(0, i).toLocaleString('es-ES', { month: 'long' }) }))}
              />
              <InputField
                label="Año"
                type="select"
                value={reportYear}
                onChange={(e) => setReportYear(parseInt(e.target.value))}
                options={Array.from({ length: 5 }, (_, i) => ({ value: new Date().getFullYear() - 2 + i, label: new Date().getFullYear() - 2 + i }))}
              />
            </div>

            {/* Owners Report Section */}
            <h4 className="text-lg font-semibold text-gray-800 mb-2 mt-6">Reportes de Propietarios</h4>
            <div className="flex justify-end gap-2 mb-4">
              <Button onClick={() => downloadPDF(ownersPdfContentRef, 'reporte_propietarios_general.pdf', getFilteredAndSortedOwners(), 'Reporte General de Propietarios')} disabled={!pdfLibsLoaded}>Descargar Reporte General de Propietarios PDF</Button>
              <Button onClick={() => downloadPDF(ownersBlock2223PdfContentRef, 'reporte_propietarios_bloques_22_23.pdf', getFilteredAndSortedOwners(['Bloque 22', 'Bloque 23']), 'Reporte de Propietarios (Bloques 22 y 23)')} disabled={!pdfLibsLoaded}>Reporte Propietarios (Bloques 22 y 23)</Button>
              <Button onClick={() => downloadPDF(ownersOtherBlocksPdfContentRef, 'reporte_propietarios_otros_bloques.pdf', getFilteredAndSortedOwners(buildingOptions.filter(b => b !== 'Bloque 22' && b !== 'Bloque 23')), 'Reporte de Propietarios (Otros Bloques)')} disabled={!pdfLibsLoaded}>Reporte Propietarios (Otros Bloques)</Button>
            </div>

            {/* Hidden content for Owners Block 22/23 PDF generation only */}
            <div ref={ownersBlock2223PdfContentRef} className="absolute -left-[9999px] w-full p-4 bg-white">
              {/* Content will be injected here by the downloadPDF function */}
            </div>

            {/* Hidden content for Owners Other Blocks PDF generation only */}
            <div ref={ownersOtherBlocksPdfContentRef} className="absolute -left-[9999px] w-full p-4 bg-white">
              {/* Content will be injected here by the downloadPDF function */}
            </div>

            {/* Payments Report Section */}
            <h4 className="text-lg font-semibold text-gray-800 mb-2">Pagos del Mes</h4>
            <div className="flex justify-end gap-2 mb-4">
              <Button onClick={() => downloadPDF(paymentsReportPdfContentRef, `reporte_pagos_${reportMonth}-${reportYear}.pdf`, filteredPayments, `Reporte de Pagos Mensual - ${new Date(reportYear, reportMonth - 1).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}`)} disabled={!pdfLibsLoaded}>Descargar Reporte de Pagos PDF</Button>
              <Button onClick={() => downloadPDF(paymentsBlock2223PdfContentRef, `reporte_pagos_bloques_22_23_${reportMonth}-${reportYear}.pdf`, filteredPayments.filter(p => { const owner = owners.find(o => o.id === p.ownerId); return owner && (owner.building === 'Bloque 22' || owner.building === 'Bloque 23'); }), `Reporte de Pagos Mensual (Bloques 22 y 23) - ${new Date(reportYear, reportMonth - 1).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}`)} disabled={!pdfLibsLoaded}>Reporte Pagos (Bloques 22 y 23)</Button>
              <Button onClick={() => downloadPDF(paymentsOtherBlocksPdfContentRef, `reporte_pagos_otros_bloques_${reportMonth}-${reportYear}.pdf`, filteredPayments.filter(p => { const owner = owners.find(o => o.id === p.ownerId); return owner && !(owner.building === 'Bloque 22' || owner.building === 'Bloque 23'); }), `Reporte de Pagos Mensual (Otros Bloques) - ${new Date(reportYear, reportMonth - 1).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}`)} disabled={!pdfLibsLoaded}>Reporte Pagos (Otros Bloques)</Button>
            </div>
            {/* Visible table in the UI */}
            <div className="overflow-x-auto rounded-lg shadow-md mb-6">
              <table className="min-w-full bg-white border border-gray-200">
                <thead className="bg-gray-100">
                  {/* Corrected: No whitespace between <th> tags */}
                  <tr>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Fecha</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Propietario</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Concepto</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Monto y Modalidad</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredPayments.length === 0 ? (
                    <tr>
                      <td colSpan="4" className="py-4 px-4 text-center text-gray-500">No hay pagos para este mes.</td>
                    </tr>
                  ) : (
                    filteredPayments.map(payment => {
                      const owner = owners.find(o => o.id === payment.ownerId);
                      const totalAmounts = (payment.paymentDetails || []).reduce((acc, detail) => { // Safely access paymentDetails
                        acc[detail.currency] = (acc[detail.currency] || 0) + (parseFloat(detail.amount) || 0);
                        return acc;
                      }, {});

                      return (
                        <tr key={payment.id} className="hover:bg-gray-50">
                          <td className="py-2 px-4 border-b text-sm">{safeRender(payment.date)}</td>
                          <td className="py-2 px-4 border-b text-sm">{owner ? safeRender(owner.name) : 'Desconocido'}</td>
                          <td className="py-2 px-4 border-b text-sm">
                            {safeRender(payment.concept)}
                            {payment.concept === 'Pago de Mensualidad' && payment.monthsPaid && payment.monthsPaid.length > 0 &&
                              ` (${safeRender(payment.monthsPaid)})`
                            }
                          </td>
                          <td className="py-2 px-4 border-b text-sm">
                            {(payment.paymentDetails || []).map((detail, idx) => ( // Safely access paymentDetails
                              <div key={idx} className="mb-1 last:mb-0">
                                {safeRender(detail.currency)} {formatNumber(detail.amount)} ({safeRender(detail.method)} {detail.bank ? ` - ${safeRender(detail.bank)}` : ''} {detail.reference ? ` - Ref: ${safeRender(detail.reference)}` : ''})
                              </div>
                            ))}
                            {Object.keys(totalAmounts).map(currency => (
                              <div key={currency} className="font-bold mt-2 pt-2 border-t border-gray-200">
                                Total {safeRender(currency)}: {formatNumber(totalAmounts[currency])}
                              </div>
                            ))}
                          </td>
                          <td className="py-2 px-4 border-b text-sm">
                            <Button onClick={() => generatePaymentReceipt(payment)} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 text-xs" disabled={!pdfLibsLoaded}>Recibo</Button>
                          </td>
                        </tr>
                      );
                    })
                  )}
                </tbody>
              </table>
            </div>

            {/* Hidden content for Payments PDF generation only */}
            <div ref={paymentsReportPdfContentRef} className="absolute -left-[9999px] w-full p-4 bg-white">
              {/* Content will be injected here by the downloadPDF function */}
            </div>

            {/* Hidden content for Payments Block 22/23 PDF generation only */}
            <div ref={paymentsBlock2223PdfContentRef} className="absolute -left-[9999px] w-full p-4 bg-white">
              {/* Content will be injected here by the downloadPDF function */}
            </div>

            {/* Hidden content for Payments Other Blocks PDF generation only */}
            <div ref={paymentsOtherBlocksPdfContentRef} className="absolute -left-[9999px] w-full p-4 bg-white">
              {/* Content will be injected here by the downloadPDF function */}
            </div>


            {/* Expenses Report Section */}
            <h4 className="text-lg font-semibold text-gray-800 mb-2 mt-6">Gastos del Mes</h4>
            <div className="flex justify-end mb-4">
              <Button onClick={() => downloadPDF(expensesReportPdfContentRef, `reporte_gastos_${reportMonth}-${reportYear}.pdf`, filteredExpenses, `Reporte de Gastos Mensual - ${new Date(reportYear, reportMonth - 1).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}`)} disabled={!pdfLibsLoaded}>Descargar Reporte de Gastos PDF</Button>
            </div>
            <div className="overflow-x-auto rounded-lg shadow-md">
              <table className="min-w-full bg-white border border-gray-200">
                <thead className="bg-gray-100">
                  {/* Corrected: No whitespace between <th> tags */}
                  <tr>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Fecha</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Concepto</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Beneficiario</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Monto (USD)</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Monto (Bs.)</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Modalidad</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {expenses.length === 0 ? (
                    <tr>
                      <td colSpan="7" className="py-4 px-4 text-center text-gray-500">No hay gastos para este mes.</td>
                    </tr>
                  ) : (
                    expenses.map(expense => (
                      <tr key={expense.id} className="hover:bg-gray-50">
                        <td className="py-2 px-4 border-b text-sm">{formatDate(expense.date)}</td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(expense.concept)}</td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(expense.beneficiary)}</td>
                        <td className="py-2 px-4 border-b text-sm text-right">
                          ${expense.currency === 'USD' ? formatNumber(expense.amount) : '-'}
                        </td>
                        <td className="py-2 px-4 border-b text-sm text-right">
                          Bs. {expense.currency === 'Bolívares' ? formatNumber(expense.totalToDebit) : '-'} {/* Use totalToDebit for Bs */}
                        </td>
                        <td className="py-2 px-4 border-b text-sm">{safeRender(expense.method)}</td>
                        <td className="py-2 px-4 border-b text-sm flex gap-2">
                          <Button onClick={() => handleEditExpense(expense)} className="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 text-xs">Editar</Button>
                          <Button onClick={() => deleteExpense(expense.id)} className="bg-red-600 hover:bg-red-700 text-white px-3 py-1 text-xs">Eliminar</Button>
                          <Button onClick={() => generateExpenseReceipt(expense)} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 text-xs" disabled={!pdfLibsLoaded}>Recibo</Button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
                <tfoot>
                  <tr className="bg-gray-100 font-bold">
                    <td colSpan="3" className="py-2 px-4 border-b text-right text-sm font-semibold text-gray-700">Total del Mes:</td>
                    <td className="py-2 px-4 border-b text-right text-sm font-semibold text-gray-700">
                      ${formatNumber(filteredExpenses.reduce((sum, e) => sum + (e.currency === 'USD' ? (parseFloat(e.amount) || 0) : 0), 0))}
                    </td>
                    <td className="py-2 px-4 border-b text-right text-sm font-semibold text-gray-700">
                      Bs. {formatNumber(filteredExpenses.reduce((sum, e) => sum + (e.currency === 'Bolívares' ? (parseFloat(e.totalToDebit) || 0) : 0), 0))}
                    </td>
                    <td colSpan="2" className="py-2 px-4 border-b text-sm"></td>
                  </tr>
                </tfoot>
              </table>
            </div>

            {/* Hidden content for Expenses PDF generation only */}
            <div ref={expensesReportPdfContentRef} className="absolute -left-[9999px] w-full p-4 bg-white">
              {/* Content will be injected here by the downloadPDF function */}
            </div>

            {/* New Currency Purchases Report Section */}
            <h4 className="text-lg font-semibold text-gray-800 mb-2 mt-6">Compras de Divisas del Mes</h4>
            <div className="flex justify-end mb-4">
              <Button onClick={() => downloadPDF(currencyPurchasesPdfContentRef, `reporte_compras_divisas_${reportMonth}-${reportYear}.pdf`, filteredCurrencyPurchases, `Reporte de Compras de Divisas Mensual - ${new Date(reportYear, reportMonth - 1).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}`)} disabled={!pdfLibsLoaded}>Descargar Reporte de Compras de Divisas PDF</Button>
            </div>
            <div className="overflow-x-auto rounded-lg shadow-md">
              <table className="min-w-full bg-white border border-gray-200">
                <thead className="bg-gray-100">
                  {/* Corrected: No whitespace between <th> tags */}
                  <tr>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Fecha</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Mecanismo</th><th style="${thStyle} text-align: right;">Monto Divisas (USD)</th><th style="${thStyle} text-align: right;">Tasa de Cambio</th><th style="${thStyle} text-align: right;">Contravalor (Bs.)</th><th style="${thStyle} text-align: right;">Comisión (Bs.)</th><th style="${thStyle} text-align: right;">Retiro (Bs.)</th><th style="${thStyle} text-align: right;">Total a Debitar (Bs.)</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredCurrencyPurchases.length === 0 ? (
                    <tr>
                      <td colSpan="8" className="py-4 px-4 text-center text-gray-500">No hay compras de divisas para este mes.</td>
                    </tr>
                  ) : (
                    filteredCurrencyPurchases.map(purchase => (
                      <tr key={purchase.id} className="hover:bg-gray-50">
                        <td className="py-2 px-4 border-b text-sm">${formatDate(purchase.date)}</td>
                        <td className="py-2 px-4 border-b text-sm">${safeRender(purchase.mechanism)}</td>
                        <td className="py-2 px-4 border-b text-sm text-right">USD ${formatNumber(purchase.amount)}</td>
                        <td className="py-2 px-4 border-b text-sm text-right">${formatNumber(purchase.exchangeRate)}</td>
                        <td className="py-2 px-4 border-b text-sm text-right">Bs. ${formatNumber(purchase.countervalueBs)}</td>
                        <td className="py-2 px-4 border-b text-sm text-right">Bs. ${formatNumber(purchase.commissionPercentage)}% (${formatNumber(purchase.commissionBs)})</td>
                        <td className="py-2 px-4 border-b text-sm text-right">Bs. ${formatNumber(purchase.withdrawalCommission)}</td>
                        <td className="py-2 px-4 border-b text-sm text-right">Bs. ${formatNumber(purchase.totalToDebit)}</td>
                      </tr>
                    ))
                  )}
                </tbody>
                <tfoot>
                  <tr className="bg-gray-100 font-bold">
                    <td colSpan="2" className="py-2 px-4 border-b text-right text-sm font-semibold text-gray-700">Total del Mes:</td>
                    <td className="py-2 px-4 border-b text-right text-sm font-semibold text-gray-700">
                      USD ${formatNumber(filteredCurrencyPurchases.reduce((sum, cp) => sum + (parseFloat(cp.amount) || 0), 0))}
                    </td>
                    <td colSpan="4" className="py-2 px-4 border-b text-sm"></td>
                    <td className="py-2 px-4 border-b text-right text-sm font-semibold text-gray-700">
                      Bs. ${formatNumber(filteredCurrencyPurchases.reduce((sum, cp) => sum + (parseFloat(cp.totalToDebit) || 0), 0))}
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>

            {/* Hidden content for Currency Purchases PDF generation only */}
            <div ref={currencyPurchasesPdfContentRef} className="absolute -left-[9999px] w-full p-4 bg-white">
              {/* Content will be injected here by the downloadPDF function */}
            </div>

            {/* NEW: Commercial Payments Report Section */}
            <h4 className="text-lg font-semibold text-gray-800 mb-2 mt-6">Pagos de Comercios del Mes</h4>
            <div className="flex justify-end mb-4">
              <Button onClick={() => downloadPDF(commercialPaymentsReportPdfContentRef, `reporte_pagos_comercios_${reportMonth}-${reportYear}.pdf`, filteredCommercialPayments, `Reporte de Pagos de Comercios Mensual - ${new Date(reportYear, reportMonth - 1).toLocaleString('es-ES', { month: 'long', year: 'numeric' })}`)} disabled={!pdfLibsLoaded}>Descargar Reporte de Pagos de Comercios PDF</Button>
            </div>
            <div className="overflow-x-auto rounded-lg shadow-md mb-6">
              <table className="min-w-full bg-white border border-gray-200">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Comercio</th>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Fecha</th>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Concepto</th>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Monto y Modalidad</th>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredCommercialPayments.length === 0 ? (
                    <tr>
                      <td colSpan="5" className="py-4 px-4 text-center text-gray-500">No hay pagos de comercios para este mes.</td>
                    </tr>
                  ) : (
                    filteredCommercialPayments.map(payment => {
                      const totalAmounts = (payment.paymentDetails || []).reduce((acc, detail) => { // Safely access paymentDetails
                        acc[detail.currency] = (acc[detail.currency] || 0) + (parseFloat(detail.amount) || 0);
                        return acc;
                      }, {});

                      return (
                        <tr key={payment.id} className="hover:bg-gray-50">
                          <td className="py-2 px-4 border-b text-sm">${safeRender(payment.name)}</td>
                          <td className="py-2 px-4 border-b text-sm">${safeRender(payment.date)}</td>
                          <td className="py-2 px-4 border-b text-sm">
                            ${safeRender(payment.concept)}
                            {payment.concept === 'Aporte Mensual' && payment.monthsPaid && payment.monthsPaid.length > 0 &&
                              ` (${safeRender(payment.monthsPaid)})`
                            }
                          </td>
                          <td className="py-2 px-4 border-b text-sm">
                            {(payment.paymentDetails || []).map((detail, idx) => ( // Safely access paymentDetails
                              <div key={idx} className="mb-1 last:mb-0">
                                ${safeRender(detail.currency)} ${formatNumber(detail.amount)} (${safeRender(detail.method)} ${detail.bank ? ` - ${safeRender(detail.bank)}` : ''} {detail.reference ? ` - Ref: ${safeRender(detail.reference)}` : ''})
                              </div>
                            ))}
                            {Object.keys(totalAmounts).map(currency => (
                              <div key={currency} className="font-bold mt-2 pt-2 border-t border-gray-200">
                                Total ${safeRender(currency)}: ${formatNumber(totalAmounts[currency])}
                              </div>
                            ))}
                          </td>
                          <td className="py-2 px-4 border-b text-sm">
                            <Button onClick={() => generateCommercialPaymentReceipt(payment)} className="bg-green-600 hover:bg-green-700 text-white px-3 py-1 text-xs" disabled={!pdfLibsLoaded}>Recibo</Button>
                          </td>
                        </tr>
                      );
                    })
                  )}
                </tbody>
              </table>
            </div>

            {/* Hidden content for Commercial Payments PDF generation only */}
            <div ref={commercialPaymentsReportPdfContentRef} className="absolute -left-[9999px] w-full p-4 bg-white">
              {/* Content will be injected here by the downloadPDF function */}
            </div>


            {/* New Pending Payments Report Section */}
            <h4 className="text-lg font-semibold text-gray-800 mb-2 mt-6">Pagos Pendientes</h4>
            <div className="flex justify-end mb-4">
              <Button onClick={() => downloadPDF(pendingPaymentsPdfContentRef, `reporte_pagos_pendientes_${reportYear}.pdf`, pendingPaymentsReport, `Reporte de Pagos Pendientes - A partir de ${reportYear} hasta ${monthsOfYear[new Date().getMonth() - 1] || monthsOfYear[11]} ${new Date().getMonth() === 0 ? new Date().getFullYear() - 1 : new Date().getFullYear()}`)} disabled={!pdfLibsLoaded}>Descargar Reporte de Pagos Pendientes PDF</Button>
            </div>
            <div className="overflow-x-auto rounded-lg shadow-md">
              <table className="min-w-full bg-white border border-gray-200">
                <thead className="bg-gray-100">
                  {/* Corrected: No whitespace between <th> tags */}
                  <tr>
                    <th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Propietario</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Edificio/Apto</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Vehículo</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Monto Pendiente (USD)</th><th className="py-2 px-4 border-b text-left text-sm font-semibold text-gray-700">Meses Pendientes</th>
                  </tr>
                </thead>
                <tbody>
                  {pendingPaymentsReport.length === 0 ? (
                    <tr>
                      <td colSpan="5" className="py-4 px-4 text-center text-gray-500">No hay pagos pendientes para este período.</td>
                    </tr>
                  ) : (
                    pendingPaymentsReport.map(item => (
                      <tr key={item.owner.name + item.owner.apartment} className="hover:bg-gray-50">
                        <td className="py-2 px-4 border-b text-sm">${safeRender(item.owner.name)}</td>
                        <td className="py-2 px-4 border-b text-sm">${safeRender(item.owner.building)} ${safeRender(item.owner.apartment)}</td>
                        <td className="py-2 px-4 border-b text-sm">${safeRender(item.owner.carMake)} ${safeRender(item.owner.carModel)}</td>
                        <td className="py-2 px-4 border-b text-sm text-right">${formatNumber(item.pendingAmountUSD)}</td>
                        <td className="py-2 px-4 border-b text-sm">${safeRender(item.pendingMonths)}</td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </div>

            {/* Hidden content for Pending Payments PDF generation only */}
            <div ref={pendingPaymentsPdfContentRef} className="absolute -left-[9999px] w-full p-4 bg-white">
              {/* Content will be injected here by the downloadPDF function */}
            </div>


            {/* Monthly Summary Section (existing) */}
            <div className="mt-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
              <h4 className="text-lg font-semibold text-gray-700 mb-2">Resumen del Mes:</h4>
              <p className="text-md text-gray-700">Ingresos Totales (USD): <span className="font-bold text-emerald-600">${formatNumber(monthlySummary.totalIncomeUSD)}</span></p>
              <p className="text-md text-gray-700">Ingresos Totales (Bs.): <span className="font-bold text-emerald-600">${formatNumber(monthlySummary.totalIncomeVES)}</span></p>
              <p className="text-md text-gray-700">Gastos Totales (USD): <span className="font-bold text-rose-600">${formatNumber(monthlySummary.totalExpensesUSD)}</span></p>
              <p className="text-md text-gray-700">Gastos Totales (Bs.): <span className="font-bold text-rose-600">${formatNumber(monthlySummary.totalExpensesVES)}</span></p>
              <p className="text-md text-gray-700">Compras de Divisas (USD): <span className="font-bold text-blue-600">${formatNumber(monthlySummary.totalCurrencyPurchasesUSD)}</span></p> {/* Displaying new summary */}
              <p className="text-lg text-gray-800 mt-2">Disponibilidad Real (USD): <span className="font-extrabold text-indigo-700">${formatNumber(monthlySummary.realAvailabilityUSD)}</span></p>
              <p className="text-lg text-gray-800">Disponibilidad Real (Bs.): <span className="font-extrabold text-indigo-700">${formatNumber(monthlySummary.realAvailabilityVES)}</span></p>
            </div>
          </section>
        )}
      </main>

      {/* Confirmation Modal */}
      <ConfirmationModal
        show={showConfirmationModal}
        title="Confirmar Eliminación"
        message={`¿Está seguro de que desea eliminar este ${itemToDeleteType === 'owner' ? 'propietario' : 'gasto'}? Esta acción no se puede deshacer.`}
        onConfirm={handleConfirmDeletion}
        onCancel={handleCancelDeletion}
      />
    </div>
  );
}

export default App;